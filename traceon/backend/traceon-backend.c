#include <stdio.h>
#include <assert.h>
#include <math.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdbool.h>

#ifdef _MSC_VER
#define EXPORT __declspec(dllexport)

#include <Python.h>
PyMODINIT_FUNC PyInit_traceon_backend(void) {
	return NULL;
}

#else
#define EXPORT extern
#endif

#if defined(__clang__)
	#define UNROLL _Pragma("clang loop unroll(full)")
#elif defined(__GNUC__) || defined(__GNUG__)
	#define UNROLL _Pragma("GCC unroll 100")
#else
	#define UNROLL
#endif


#define DERIV_2D_MAX 9
#define NU_MAX 4
#define M_MAX 8

// DERIV_2D_MAX, NU_MAX_SYM and M_MAX_SYM need to be present in the .so file to
// be able to read them. We cannot call them NU_MAX and M_MAX as
// the preprocessor will substitute their names. We can also not 
// simply only use these symbols instead of the preprocessor variables
// as the length of arrays need to be a compile time constant in C...
EXPORT const int DERIV_2D_MAX_SYM = 9;
EXPORT const int NU_MAX_SYM = NU_MAX;
EXPORT const int M_MAX_SYM = M_MAX;


#define TRACING_STEP_MAX 0.01
#define MIN_DISTANCE_AXIS 1e-10

#ifndef M_PI
    #define M_PI 3.14159265358979323846
#endif


EXPORT const size_t TRACING_BLOCK_SIZE = (size_t) 1e5;

#define N_QUAD_2D 4
EXPORT const int N_QUAD_2D_SYM = N_QUAD_2D;
const double GAUSS_QUAD_POINTS[N_QUAD_2D] = {-0.3399810435848563, 0.3399810435848563, -0.8611363115940526, 0.8611363115940526};
const double GAUSS_QUAD_WEIGHTS[N_QUAD_2D] = {0.6521451548625461, 0.6521451548625461, 0.3478548451374538, 0.3478548451374538};


//////////////////////////////// TYPEDEFS

typedef double (*integration_cb_2d)(double, double, double, double, void*);
typedef double (*vertices_2d)[4][3];
typedef double (*charges_2d)[N_QUAD_2D];

// See GMSH documentation
typedef double triangle6[6][3];
typedef double (*vertices_3d)[6][3];

//////////////////////////////// ELLIPTIC FUNCTIONS

// Chebyshev Approximations for the Complete Elliptic Integrals K and E.
// W. J. Cody. 1965.
//
// Augmented with the tricks shown on the Scipy documentation for ellipe and ellipk.


double ellipk_singularity(double k) {
	double eta = 1 - k;
	
	double A[] = {log(4.0),
			9.65736020516771e-2,
			3.08909633861795e-2,
			1.52618320622534e-2,
			1.25565693543211e-2,
			1.68695685967517e-2,
			1.09423810688623e-2,
			1.40704915496101e-3};
	
	double B[] = {1.0/2.0,
			1.24999998585309e-1,
			7.03114105853296e-2,
			4.87379510945218e-2,
			3.57218443007327e-2,
			2.09857677336790e-2,
			5.81807961871996e-3,
			3.42805719229748e-4};
	
	double L = log(1./eta);
	double sum_ = 0.0;

	for(int i = 0; i < 8; i++)
		sum_ += (A[i] + L*B[i])*pow(eta, i);
	
	return sum_;
}

EXPORT double ellipk(double k) {
	if(k > -1) return ellipk_singularity(k);
	
	return ellipk_singularity(1 - 1./(1-k))/sqrt(1-k);
}

double ellipe_01(double k) {
	double eta = 1 - k;
	
	double A[] = {1,
        4.43147193467733e-1,
        5.68115681053803e-2,
        2.21862206993846e-2,
        1.56847700239786e-2,
        1.92284389022977e-2,
        1.21819481486695e-2,
        1.55618744745296e-3};

    double B[] = {0,
        2.49999998448655e-1,
        9.37488062098189e-2,
        5.84950297066166e-2,
        4.09074821593164e-2,
        2.35091602564984e-2,
        6.45682247315060e-3,
        3.78886487349367e-4};
	
	double L = log(1./eta);
	double sum_ = 0.0;

	for(int i = 0; i < 8; i++)
		sum_ += (A[i] + L*B[i])*pow(eta, i);
		
	return sum_;
}

EXPORT double ellipe(double k) {
	if (0 <= k && k <= 1) return ellipe_01(k);

	return ellipe_01(k/(k-1.))*sqrt(1-k);
}


//////////////////////////////// UTILITIES 2D



EXPORT inline double
norm_2d(double x, double y) {
	return sqrt(x*x + y*y);
}

EXPORT inline double
length_2d(double *v1, double *v2) {
	return norm_2d(v2[0]-v1[0], v2[1]-v1[1]);
}

EXPORT void
normal_2d(double *p1, double *p2, double *normal) {
	double x1 = p1[0], y1 = p1[1];
	double x2 = p2[0], y2 = p2[1];
	
	double tangent_x = x2 - x1, tangent_y = y2 - y1;
	double normal_x = tangent_y, normal_y = -tangent_x;
	double length = norm_2d(normal_x, normal_y);

	normal[0] = normal_x/length;
	normal[1] = normal_y/length;
}

void
higher_order_normal_radial(double alpha, double *v1, double *v2, double *v3, double *v4, double *normal) {

	double v1x = v1[0], v1y = v1[1];
	double v2x = v2[0], v2y = v2[1];
	double v3x = v3[0], v3y = v3[1];
	double v4x = v4[0], v4y = v4[1];
		
	double a2 = pow(alpha, 2);
	double a3 = pow(alpha, 3);
	
	double dx = (2*alpha*(9*v4x-9*v3x-9*v2x+9*v1x)+3*a2*(9*v4x-27*v3x+27*v2x-9*v1x)-v4x+27*v3x-27*v2x+v1x)/16;
	double dy = (2*alpha*(9*v4y-9*v3y-9*v2y+9*v1y)+3*a2*(9*v4y-27*v3y+27*v2y-9*v1y)-v4y+27*v3y-27*v2y+v1y)/16;

	double zero[2] = {0., 0.};
	double vec[2] = {dx, dy};
	normal_2d(zero, vec, normal);
}


EXPORT void inline position_and_jacobian_radial(double alpha, double *v1, double *v2, double *v3, double *v4, double *pos_out, double *jac) {

	double v1x = v1[0], v1y = v1[1];
	double v2x = v2[0], v2y = v2[1];
	double v3x = v3[0], v3y = v3[1];
	double v4x = v4[0], v4y = v4[1];
		
	double a2 = pow(alpha, 2);
	double a3 = pow(alpha, 3);
	
	// Higher order line element parametrization. 
	pos_out[0] = (a2*(9*v4x-9*v3x-9*v2x+9*v1x)+a3*(9*v4x-27*v3x+27*v2x-9*v1x)-v4x+alpha*(-v4x+27*v3x-27*v2x+v1x)+9*v3x+9*v2x-v1x)/16;
	pos_out[1] = (a2*(9*v4y-9*v3y-9*v2y+9*v1y)+a3*(9*v4y-27*v3y+27*v2y-9*v1y)-v4y+alpha*(-v4y+27*v3y-27*v2y+v1y)+9*v3y+9*v2y-v1y)/16;
	
	// Term following from the Jacobian
	*jac = 1/16. * sqrt(pow(2*alpha*(9*v4y-9*v3y-9*v2y+9*v1y)+3*a2*(9*v4y-27*v3y+27*v2y-9*v1y)-v4y+27*v3y-27*v2y+v1y, 2) +pow(2*alpha*(9*v4x-9*v3x-9*v2x+9*v1x)+3*a2*(9*v4x-27*v3x+27*v2x-9*v1x)-v4x+27*v3x-27*v2x+v1x, 2));
}

//////////////////////////////// UTILITIES 3D


typedef double (*integration_cb_3d)(double, double, double, double, double, double, void*);

EXPORT inline double
norm_3d(double x, double y, double z) {
	return sqrt(x*x + y*y + z*z);
}

EXPORT void
normal_3d(double *p1, double *p2, double *p3, double *normal) {
	double x1 = p1[0], y1 = p1[1], z1 = p1[2];
	double x2 = p2[0], y2 = p2[1], z2 = p2[2];
	double x3 = p3[0], y3 = p3[1], z3 = p3[2];

	double normal_x = (y2-y1)*(z3-z1)-(y3-y1)*(z2-z1);
	double normal_y = (x3-x1)*(z2-z1)-(x2-x1)*(z3-z1);
	double normal_z = (x2-x1)*(y3-y1)-(x3-x1)*(y2-y1);
	double length = norm_3d(normal_x, normal_y, normal_z);
	
	normal[0] = normal_x/length;
	normal[1] = normal_y/length;
	normal[2] = normal_z/length;
}

void barycentric_coefficients_higher_order_triangle_3d(double alpha, double beta,
	double v0, double v1, double v2, double v3, double v4, double v5, double coeffs[6]) {
	//v3 = (v0+v1)/2.;
	//v4 = (v1+v2)/2.;
	//v5 = (v0+v2)/2.;
    coeffs[0] = v0;
	coeffs[1] = 4*v3-v1-3*v0;
	coeffs[2] = 4*v5-v2-3*v0;
	coeffs[3] = -4*v3+2*v1+2*v0;
	coeffs[4] = -4*v5+4*v4-4*v3+4*v0;
	coeffs[5] = -4*v5+2*v2+2*v0;
}

double dot6(double *v1, double *v2) {
	double sum = 0.0;
	for(int i = 0; i < 6; i++) sum += v1[i]*v2[i];
	return sum;
}

void
cross_product_3d(double *v1, double *v2, double *out) {
	double v1x = v1[0], v1y = v1[1], v1z = v1[2];
	double v2x = v2[0], v2y = v2[1], v2z = v2[2];

	out[0] = v1y*v2z-v1z*v2y;
	out[1] = v1z*v2x-v1x*v2z;
	out[2] = v1x*v2y-v1y*v2x;
}

double norm_cross_product_3d(double *v1, double *v2) {
	double out[3];
	cross_product_3d(v1, v2, out);
	return norm_3d(out[0], out[1], out[2]);
}

EXPORT void position_and_jacobian_3d(double alpha, double beta, triangle6 v, double *pos_out, double *jac) {

	double coeffs_x[6], coeffs_y[6], coeffs_z[6];
	barycentric_coefficients_higher_order_triangle_3d(alpha, beta, v[0][0], v[1][0], v[2][0], v[3][0], v[4][0], v[5][0], coeffs_x);
	barycentric_coefficients_higher_order_triangle_3d(alpha, beta, v[0][1], v[1][1], v[2][1], v[3][1], v[4][1], v[5][1], coeffs_y);
	barycentric_coefficients_higher_order_triangle_3d(alpha, beta, v[0][2], v[1][2], v[2][2], v[3][2], v[4][2], v[5][2], coeffs_z);
	
	double monomials[6] = {1, alpha, beta, pow(alpha,2), alpha*beta, pow(beta,2)};
	double monomials_da[6] = {0, 1, 0, 2*alpha, beta, 0};
	double monomials_db[6] = {0, 0, 1, 0, alpha, 2*beta};

	pos_out[0] = dot6(coeffs_x, monomials);
	pos_out[1] = dot6(coeffs_y, monomials);
	pos_out[2] = dot6(coeffs_z, monomials);

	double da[3] = {
		dot6(coeffs_x, monomials_da),
		dot6(coeffs_y, monomials_da),
		dot6(coeffs_z, monomials_da),
	};
	
	double db[3] = {
		dot6(coeffs_x, monomials_db),
		dot6(coeffs_y, monomials_db),
		dot6(coeffs_z, monomials_db),
	};
	
	*jac = norm_cross_product_3d(da, db);
}

// Triangle quadrature constants
#define N_TRIANGLE_QUAD 33
const double QUAD_WEIGHTS[N_TRIANGLE_QUAD] = {0.03127061, 0.01424303, 0.02495917, 0.01213342, 0.00396582, 0.03127061, 0.01424303, 0.02495917, 0.01213342, 0.00396582, 0.03127061, 0.01424303, 0.02495917, 0.01213342, 0.00396582, 0.02161368, 0.00754184, 0.01089179, 0.02161368, 0.00754184, 0.01089179, 0.02161368, 0.00754184, 0.01089179, 0.02161368, 0.00754184, 0.01089179, 0.02161368, 0.00754184, 0.01089179, 0.02161368, 0.00754184, 0.01089179};
const double QUAD_B1[N_TRIANGLE_QUAD] = {0.27146251, 0.10925783, 0.44011165, 0.48820375, 0.02464636, 0.27146251, 0.10925783, 0.44011165, 0.48820375, 0.02464636, 0.45707499, 0.78148434, 0.1197767 , 0.0235925 , 0.95070727, 0.11629602, 0.02138249, 0.02303416, 0.62824975, 0.85133779, 0.68531016, 0.25545423, 0.12727972, 0.29165568, 0.25545423, 0.12727972, 0.29165568, 0.62824975, 0.85133779, 0.68531016, 0.11629602, 0.02138249, 0.02303416};
const double QUAD_B2[N_TRIANGLE_QUAD] = {0.27146251, 0.10925783, 0.44011165, 0.48820375, 0.02464636, 0.45707499, 0.78148434, 0.1197767 , 0.0235925 , 0.95070727, 0.27146251, 0.10925783, 0.44011165, 0.48820375, 0.02464636, 0.25545423, 0.12727972, 0.29165568, 0.11629602, 0.02138249, 0.02303416, 0.62824975, 0.85133779, 0.68531016, 0.11629602, 0.02138249, 0.02303416, 0.25545423, 0.12727972, 0.29165568, 0.62824975, 0.85133779, 0.68531016};

//const double QUAD_B1[N_TRIANGLE_QUAD] = {0.333333333333333333333333333333, 0.950275662924105565450352089520, 0.024862168537947217274823955239, 0.024862168537947217274823955239, 0.171614914923835347556304795551, 0.414192542538082326221847602214, 0.414192542538082326221847602214, 0.539412243677190440263092985511, 0.230293878161404779868453507244, 0.230293878161404779868453507244, 0.772160036676532561750285570113, 0.113919981661733719124857214943, 0.113919981661733719124857214943, 0.009085399949835353883572964740, 0.495457300025082323058213517632, 0.495457300025082323058213517632, 0.062277290305886993497083640527, 0.468861354847056503251458179727, 0.468861354847056503251458179727, 0.022076289653624405142446876931, 0.022076289653624405142446876931, 0.851306504174348550389457672223, 0.851306504174348550389457672223, 0.126617206172027096933163647918, 0.126617206172027096933163647918, 0.018620522802520968955913511549, 0.018620522802520968955913511549, 0.689441970728591295496647976487, 0.689441970728591295496647976487, 0.291937506468887771754472382212, 0.291937506468887771754472382212, 0.096506481292159228736516560903, 0.096506481292159228736516560903, 0.635867859433872768286976979827, 0.635867859433872768286976979827, 0.267625659273967961282458816185, 0.267625659273967961282458816185};
//const double QUAD_B2[N_TRIANGLE_QUAD] = {0.333333333333333333333333333333, 0.02486216853794721727482395523, 0.95027566292410556545035208952, 0.02486216853794721727482395523, 0.41419254253808232622184760221, 0.17161491492383534755630479555, 0.41419254253808232622184760221, 0.23029387816140477986845350724, 0.53941224367719044026309298551, 0.23029387816140477986845350724, 0.11391998166173371912485721494, 0.77216003667653256175028557011, 0.11391998166173371912485721494, 0.49545730002508232305821351763, 0.00908539994983535388357296474, 0.49545730002508232305821351763, 0.46886135484705650325145817972, 0.06227729030588699349708364052, 0.46886135484705650325145817972, 0.85130650417434855038945767222, 0.12661720617202709693316364791, 0.02207628965362440514244687693, 0.12661720617202709693316364791, 0.02207628965362440514244687693, 0.85130650417434855038945767222, 0.68944197072859129549664797648, 0.29193750646888777175447238221, 0.01862052280252096895591351154, 0.29193750646888777175447238221, 0.01862052280252096895591351154, 0.68944197072859129549664797648, 0.63586785943387276828697697982, 0.26762565927396796128245881618, 0.09650648129215922873651656090, 0.26762565927396796128245881618, 0.09650648129215922873651656090, 0.63586785943387276828697697982};
//const double QUAD_WEIGHTS[N_TRIANGLE_QUAD] = {0.051739766065744133555179145422, 0.00800779955556480159780412346, 0.00800779955556480159780412346, 0.00800779955556480159780412346, 0.04686889898182164482322673207, 0.04686889898182164482322673207, 0.04686889898182164482322673207, 0.04659094018397648796036177007, 0.04659094018397648796036177007, 0.04659094018397648796036177007, 0.03101694331379638140764622013, 0.03101694331379638140764622013, 0.03101694331379638140764622013, 0.01079161273663127362317824013, 0.01079161273663127362317824013, 0.01079161273663127362317824013, 0.03219553424243161881941448220, 0.03219553424243161881941448220, 0.03219553424243161881941448220, 0.01544583421070158381769290005, 0.01544583421070158381769290005, 0.01544583421070158381769290005, 0.01544583421070158381769290005, 0.01544583421070158381769290005, 0.01544583421070158381769290005, 0.01782298992317866188874831948, 0.01782298992317866188874831948, 0.01782298992317866188874831948, 0.01782298992317866188874831948, 0.01782298992317866188874831948, 0.01782298992317866188874831948, 0.03703868368138462791854647219, 0.03703868368138462791854647219, 0.03703868368138462791854647219, 0.03703868368138462791854647219, 0.03703868368138462791854647219, 0.03703868368138462791854647219};

EXPORT double
triangle_integral(double target[3], triangle6 vertices, integration_cb_3d function, void *args) {
	
	double sum_ = 0.0;
	
	for (int k=0; k < N_TRIANGLE_QUAD; k++) {
		double b1_ = QUAD_B1[k];
		double b2_ = QUAD_B2[k];
		double w = QUAD_WEIGHTS[k];
		
		double pos[3], jac;
		position_and_jacobian_3d(b1_, b2_, vertices, pos, &jac);
		
        sum_ += w*jac*function(target[0], target[1], target[2], pos[0], pos[1], pos[2], args);
	}
	      
    return sum_;
}

#define N_SINGULAR_3D 784
const double QUAD_SINGULAR_WEIGHTS[N_SINGULAR_3D] = 
{5.2143376077259586e-26,9.2137168653615843e-23,5.1386176748032007e-21,8.0029074152136500e-20,6.3597649705545971e-19,3.3232879699908914e-18,1.3013727738166960e-17,4.1212922247400686e-17,1.1076819186298182e-16,2.6098937698947125e-16,
 5.5149110127038694e-16,1.0625083142852278e-15,1.8894509279811935e-15,3.1302521969766053e-15,4.8656207160109460e-15,7.1343626305094958e-15,9.9080112831922901e-15,1.3070486071708585e-14,1.6408850300489991e-14,1.9620118250074262e-14,
 2.2336490844000396e-14,2.4167784508402187e-14,2.4755896260889369e-14,2.3832828597993602e-14,2.1271943665882776e-14,1.7122338416727189e-14,1.1618933037368734e-14,5.1718455972133558e-15,9.2137168647038999e-23,1.6280606446196637e-19,
 9.0799200000875851e-18,1.4141110255109732e-16,1.1237683129287623e-15,5.8722385696706691e-15,2.2995212767994503e-14,7.2823093808114404e-14,1.9572701927250242e-13,4.6116734380863554e-13,9.7448290516906231e-13,1.8774485870866563e-12,
 3.3386533803213010e-12,5.5311450135730341e-12,8.5975352999657175e-12,1.2606394566827077e-11,1.7507422327308406e-11,2.3095504550826151e-11,2.8994382818637764e-11,3.4668682392245793e-11,3.9468503551196741e-11,4.2704393244055111e-11,
 4.3743584715699158e-11,4.2112527286605185e-11,3.7587452298634515e-11,3.0255113899724673e-11,2.0530615263125835e-11,9.1386336262701139e-12,5.1386176426510491e-21,9.0799199439229751e-18,5.0639972761752120e-16,7.8866932542663686e-15,
 6.2674116904866704e-14,3.2750288682693733e-13,1.2824748986893094e-12,4.0614449101246048e-12,1.0915967238260743e-11,2.5719942167831448e-11,5.4348262731476032e-11,1.0470791076434728e-10,1.8620132802796884e-10,3.0847962628077972e-10,
 4.7949646407046170e-10,7.0307610362411258e-10,9.7641321704908943e-10,1.2880683104713223e-09,1.6170569301992388e-09,1.9335204847754471e-09,2.2012131657111963e-09,2.3816832204085956e-09,2.4396403696101223e-09,2.3486740353457501e-09,
 2.0963043292982191e-09,1.6873696505817084e-09,1.1450208787045215e-09,5.0967426795553994e-10,8.0029063462569638e-20,1.4141108367276297e-16,7.8866922501792867e-15,1.2282771726714439e-13,9.7608952991731557e-13,5.1005447645110137e-12,
 1.9973322047641020e-11,6.3253126631621748e-11,1.7000576723498080e-10,4.0056354201537553e-10,8.4642230064305710e-10,1.6307257356610587e-09,2.8999079001093507e-09,4.8042756448012184e-09,7.4676996075106854e-09,1.0949739021041853e-08,
 1.5206703581977280e-08,2.0060434095589400e-08,2.5184117731464169e-08,3.0112735436459188e-08,3.4281793350645653e-08,3.7092442140817250e-08,3.7995069402487897e-08,3.6578355600438015e-08,3.2647938389849795e-08,2.6279171217251750e-08,
 1.7832606926662927e-08,7.9376900894321888e-09,6.3597563495862675e-19,1.1237667896867987e-15,6.2674032339225947e-14,9.7608833715799028e-13,7.7567964900148054e-12,4.0533052055044455e-11,1.5872416372113040e-10,5.0266047898309897e-10,
 1.3510032616396166e-09,3.1832017263784866e-09,6.7263558612850682e-09,1.2959064998498678e-08,2.3045012502941082e-08,3.8178658121468109e-08,5.9344378080697868e-08,8.7015478193061270e-08,1.2084475998771233e-07,1.5941642647680325e-07,
 2.0013335870951192e-07,2.3930013936125061e-07,2.7243084387579374e-07,2.9476653133277759e-07,3.0193953725131423e-07,2.9068118408771980e-07,2.5944691152466187e-07,2.0883553896510293e-07,1.4171231078389922e-07,6.3079302397341159e-08,
 3.3232591670302020e-18,5.8721876753560004e-15,3.2750005040622297e-13,5.1005012393321980e-12,4.0532755698897761e-11,2.1180345504651582e-10,8.2940525252946906e-10,2.6266274254249505e-09,7.0596005996733456e-09,1.6633662889273829e-08,
 3.5148239253186372e-08,6.7716952010594934e-08,1.2042057092282592e-07,1.9950068620999131e-07,3.1010110706712100e-07,4.5469506956413471e-07,6.3146830529577673e-07,8.3302263725668895e-07,1.0457869490600794e-06,1.2504510205892024e-06,
 1.4235738753590825e-06,1.5402879034022665e-06,1.5777700903975112e-06,1.5189401238076550e-06,1.3557269802295134e-06,1.0912597607809614e-06,7.4051065796610805e-07,3.2961776901322887e-07,1.3013202362866966e-17,2.2994284433262951e-14,
 1.2824231321067411e-12,1.9972518375326711e-11,1.5871797104099049e-10,8.2937895696464586e-10,3.2477811237442588e-09,1.0285335118613849e-08,2.7643950287110225e-08,6.5134017641863795e-08,1.3763330727796397e-07,2.6516571703250919e-07,
 4.7154229607409555e-07,7.8120383355519565e-07,1.2142924329370690e-06,1.7804927802015701e-06,2.4727005717986243e-06,3.2619460615699555e-06,4.0950875368307924e-06,4.8965101299404415e-06,5.5744237772142838e-06,6.0314520103955576e-06,
 6.1782245790868597e-06,5.9478584770898730e-06,5.3087492295375545e-06,4.2731497556318611e-06,2.8996880952213599e-06,1.2907156845064996e-06,4.1206776683045191e-17,7.2812234621942705e-14,4.0608393033743273e-12,6.3243702936529661e-11,
 5.0258620483261521e-10,2.6262585113392267e-09,1.0284216578651186e-08,3.2568886237593942e-08,8.7535569981499330e-08,2.0624922633159583e-07,4.3582085323865780e-07,8.3965684856612743e-07,1.4931557620575417e-06,2.4737102379276081e-06,
 3.8451009764306510e-06,5.6379948865543030e-06,7.8298959337550796e-06,1.0329070367398698e-05,1.2967243029219395e-05,1.5504976701697282e-05,1.7651614823095678e-05,1.9098811279233658e-05,1.9563571934805829e-05,1.8834109327859780e-05,
 1.6810346743862322e-05,1.3531083495326362e-05,9.1819673942230818e-06,4.0870979709444530e-06,1.1071713918748948e-16,1.9563680938205379e-13,1.0910936175085882e-11,1.6992743486381642e-10,1.3503824194300602e-09,7.0564080121781068e-09,
 2.7632324826836336e-08,8.7508274148336506e-08,2.3519645712753836e-07,5.5416429376925922e-07,1.1709927820850122e-06,2.2560464966112124e-06,4.0119113321559054e-06,6.6465310506764130e-06,1.0331275927548803e-05,1.5148543876517949e-05,
 2.1037891038874014e-05,2.7752841003339114e-05,3.4841260756384611e-05,4.1659814277269922e-05,4.7427545966165362e-05,5.1315970743922799e-05,5.2564720933428041e-05,5.0604751736940375e-05,4.5167170306624980e-05,3.6356225245009360e-05,
 2.4670727580094235e-05,1.0981489729288918e-05,2.6066678733120890e-16,4.6059732900965699e-13,2.5688151811069179e-11,4.0006848849639858e-10,3.1792715159059424e-09,1.6613247236436089e-08,6.5056136673713106e-08,2.0602501884119348e-07,
 5.5373454662063168e-07,1.3046961578901013e-06,2.7569257003402162e-06,5.3115208418239534e-06,9.4454394837625842e-06,1.5648253816810261e-05,2.4323429279598841e-05,3.5664959318999268e-05,4.9530537995936336e-05,6.5339873814872638e-05,
 8.2028487861813564e-05,9.8081742611516427e-05,1.1166099601858660e-04,1.2081570505492369e-04,1.2375569883065114e-04,1.1914124728804573e-04,1.0633928281629470e-04,8.5595243009830449e-05,5.8083503119933125e-05,2.5854259501747131e-05,
 5.4986391959039562e-16,9.7160768072962020e-13,5.4187907813204061e-11,8.4392503334043603e-10,6.7065187516846225e-09,3.5044837649162767e-08,1.3723275861517276e-07,4.3459976452527671e-07,1.1680761148544558e-06,2.7521931374419014e-06,
 5.8156007795591860e-06,1.1204395078381815e-05,1.9924695547025484e-05,3.3009230928694070e-05,5.1309091957948546e-05,7.5233498382971736e-05,1.0448226274128707e-04,1.3783128832495548e-04,1.7303510859808627e-04,2.0689866931186004e-04,
 2.3554344442866634e-04,2.5485485822621242e-04,2.6105663221377760e-04,2.5132267094485301e-04,2.2431754906122138e-04,1.8055900524018438e-04,1.2252432700022594e-04,5.4538303913932600e-05,1.0557216647101353e-15,1.8654566004423927e-12,
 1.0403910168597717e-10,1.6203098791286536e-09,1.2876307916715867e-08,6.7285000932650346e-08,2.6348263855154922e-07,8.3441806334381638e-07,2.2426698980375011e-06,5.2841254302125799e-06,1.1165773053193481e-05,2.1512090906111360e-05,
 3.8254797236773969e-05,6.3376699189140380e-05,9.8511864566348966e-05,1.4444598258784449e-04,2.0060270263973871e-04,2.6463179702345091e-04,3.3222203966128621e-04,3.9723902553006116e-04,4.5223610497853499e-04,4.8931342028490877e-04,
 5.0122063391548394e-04,4.8253173029964380e-04,4.3068273418452263e-04,3.4666768776640242e-04,2.3524290621673098e-04,1.0471185132746051e-04,1.8654218095710690e-15,3.2961940098378026e-12,1.8383331120375439e-10,2.8630286635445186e-09,
 2.2751968077863954e-08,1.1889015106196359e-07,4.6556424560288013e-07,1.4743863896067541e-06,3.9627161962394038e-06,9.3368575747984479e-06,1.9729515146273854e-05,3.8011082738132181e-05,6.7594836282715268e-05,1.1198432393495294e-04,
 1.7406688411005999e-04,2.5523080110160504e-04,3.5445768432327586e-04,4.6759476685464136e-04,5.8702426891514580e-04,7.0190691979404689e-04,7.9908476021855340e-04,8.6459902872780417e-04,8.8563864242541214e-04,8.5261602901571967e-04,
 7.6100073741888698e-04,6.1254920406561629e-04,4.1566566498761609e-04,1.8502203536804323e-04,3.0565625986903576e-15,5.4009357437576316e-12,3.0121767663261243e-10,4.6911783099506099e-09,3.7279940824422145e-08,1.9480590782424865e-07,
 7.6284422809684155e-07,2.4158366066955884e-06,6.4930569871674005e-06,1.5298786315246213e-05,3.2327539957443663e-05,6.2282564317083010e-05,1.1075663819640471e-04,1.8349045477167834e-04,2.8521502477968559e-04,4.1820510335961232e-04,
 5.8079201988639679e-04,7.6617131223520401e-04,9.6186096661009756e-04,1.1501004372291277e-03,1.3093299213806746e-03,1.4166774723627113e-03,1.4511516572302018e-03,1.3970428843289749e-03,1.2469278420762099e-03,1.0036845164981866e-03,
 6.8108355903324718e-04,3.0316544512233541e-04,4.6668219128827857e-15,8.2462584897949217e-12,4.5990527217045305e-10,7.1625864111202430e-09,5.6919771518807210e-08,2.9743362029711389e-07,1.1647260754037453e-06,3.6885484429149397e-06,
 9.9137314060876572e-06,2.3358497956853092e-05,4.9358345197194286e-05,9.5094285348526459e-05,1.6910548678233508e-04,2.8015695654334100e-04,4.3547209800170816e-04,6.3852405354769667e-04,8.8676506294837088e-04,1.1698059351028620e-03,
 1.4685888775992826e-03,1.7559967280816342e-03,1.9991115414781779e-03,2.1630119645979005e-03,2.2156478508831394e-03,2.1330334764342600e-03,1.9038347782172834e-03,1.5324459238040327e-03,1.0398922237556791e-03,4.6287916469696529e-04,
 6.6567983298720743e-15,1.1762540068440573e-11,6.5601317231162317e-10,1.0216780101998122e-08,8.1190893300884484e-08,4.2426209180512210e-07,1.6613761438170491e-06,5.2613799225265444e-06,1.4141038998010330e-05,3.3318779479941424e-05,
 7.0405204228367278e-05,1.3564337609305060e-04,2.4121364453127050e-04,3.9961849739145958e-04,6.2116146465357263e-04,9.1079666903634256e-04,1.2648899615664169e-03,1.6686221030999002e-03,2.0948088806827269e-03,2.5047701208581008e-03,
 2.8515513595674170e-03,3.0853404527138354e-03,3.1604207721379956e-03,3.0425788574215602e-03,2.7156476952771816e-03,2.1858951673380833e-03,1.4833119728084269e-03,6.6025516036543285e-04,8.8767296700781866e-15,1.5685151216383102e-11,
 8.7478263604428699e-10,1.3623906053619930e-08,1.0826670356978709e-07,5.6574643118087935e-07,2.2154174091171984e-06,7.0159624716680559e-06,1.8856839912977104e-05,4.4430037342902662e-05,9.3884166882050101e-05,1.8087818219031062e-04,
 3.2165437634334494e-04,5.3288460859456468e-04,8.2830846451458515e-04,1.2145321842127453e-03,1.6867096905783003e-03,2.2250797751026045e-03,2.7933927427026303e-03,3.3400692264886019e-03,3.8024962309035921e-03,4.1142500916688711e-03,
 4.2143684467767090e-03,4.0572282167583079e-03,3.6212709587387579e-03,2.9148547884525408e-03,1.9779718036408967e-03,8.8043925644217317e-04,1.1053834763991398e-14,1.9532088532396448e-11,1.0893316652231904e-09,1.6965302758344601e-08,
 1.3482017546805872e-07,7.0450129732701299e-07,2.7587702773239624e-06,8.7366961431304090e-06,2.3481665018109178e-05,5.5326940168280188e-05,1.1691018046514806e-04,2.2524033204282702e-04,4.0054326980340738e-04,6.6357979014884942e-04,
 1.0314592468916551e-03,1.5124081253810445e-03,2.1003918005212123e-03,2.7708024334221599e-03,3.4784997354206505e-03,4.1592539935456163e-03,4.7350957604117465e-03,5.1233103159987955e-03,5.2479836805527603e-03,5.0523032664860669e-03,
 4.5094232111707834e-03,3.6297515402763966e-03,2.4630888061152284e-03,1.0963756273043640e-03,1.2818185076661236e-14,2.2649689550053157e-11,1.2632045975741073e-09,1.9673208011617573e-08,1.5633940601745587e-07,8.1694979241980505e-07,
 3.1991095175337744e-06,1.0131197951864471e-05,2.7229674998470919e-05,6.4157912068001490e-05,1.3557071935160864e-04,2.6119191434439948e-04,4.6447571120533226e-04,7.6949662672437177e-04,1.1960949125782621e-03,1.7538101189763346e-03,
 2.4356444082452521e-03,3.2130621780385614e-03,4.0337181032402969e-03,4.8231304889579359e-03,5.4908848475273761e-03,5.9410640051875685e-03,6.0856370239727462e-03,5.8587232137939085e-03,5.2291917279309250e-03,4.2091118619868705e-03,
 2.8562330495373895e-03,1.2713728768687820e-03,1.3776750040975520e-14,2.4343470590460123e-11,1.3576691151913441e-09,2.1144402866647368e-08,1.6803072395784826e-07,8.7804264167529637e-07,3.4383441893825763e-06,1.0888825599234931e-05,
 2.9265954884203191e-05,6.8955746264039015e-05,1.4570892074128509e-04,2.8072427532649987e-04,4.9920996889264301e-04,8.2704085019474623e-04,1.2855408575646269e-03,1.8849629244676153e-03,2.6177859034186104e-03,3.4533402527902606e-03,
 4.3353661779530362e-03,5.1838121203574526e-03,5.9015022482315728e-03,6.3853465437889593e-03,6.5407309707230903e-03,6.2968481725747686e-03,5.6202392866998522e-03,4.5238761704790688e-03,3.0698268551213100e-03,1.3664482318474535e-03,
 1.3626449338674082e-14,2.4077889759326633e-11,1.3428573039224086e-09,2.0913723018994663e-08,1.6619755316328718e-07,8.6846342848627190e-07,3.4008327628936568e-06,1.0770031389429625e-05,2.8946671050241257e-05,6.8203457294552036e-05,
 1.4411927492105441e-04,2.7766164766691815e-04,4.9376372005330998e-04,8.1801805307303501e-04,1.2715159465257770e-03,1.8643984770822001e-03,2.5892265509887273e-03,3.4156652232124251e-03,4.2880684786159497e-03,5.1272580999991617e-03,
 5.8371184182350521e-03,6.3156841003886586e-03,6.4693733242868470e-03,6.2281512230178250e-03,5.5589239612870598e-03,4.4745218769391979e-03,3.0363358553647463e-03,1.3515406427357698e-03,1.2273216365126131e-14,2.1686731685352255e-11,
 1.2094991019966874e-09,1.8836796089201648e-08,1.4969259259184653e-07,7.8221694427467124e-07,3.0630984846610787e-06,9.7004672469234596e-06,2.6071997775783980e-05,6.1430220552753957e-05,1.2980689242875866e-04,2.5008726730019166e-04,
 4.4472839687330573e-04,7.3678126314609686e-04,1.1452426039649079e-03,1.6792463929028217e-03,2.3320923073057924e-03,3.0764579439152740e-03,3.8622234537035870e-03,4.6180737517979419e-03,5.2574383476798308e-03,5.6884780129670548e-03,
 5.8269044695596203e-03,5.6096379632715517e-03,5.0068711840085848e-03,4.0301602979069748e-03,2.7347995052765502e-03,1.2173201046202845e-03,9.9072739881896800e-15,1.7506119530789454e-11,9.7634056432015069e-10,1.5205574020976096e-08,
 1.2083593124161755e-07,6.3142678777781212e-07,2.4726163898304306e-06,7.8304809407426342e-06,2.1046025564913865e-05,4.9588144465568516e-05,1.0478365332997699e-04,2.0187724263876495e-04,3.5899685519044606e-04,5.9474987046542185e-04,
 9.2447097182023349e-04,1.3555333510977745e-03,1.8825283256538178e-03,2.4834005086162322e-03,3.1176917949706836e-03,3.7278347089792440e-03,4.2439471966356094e-03,4.5918941354602472e-03,4.7036357353699224e-03,4.5282523034955420e-03,
 4.0416825685965930e-03,3.2532549822182006e-03,2.2076045264327023e-03,9.8265389030978271e-04,6.9883049938001996e-15,1.2348311219101911e-11,6.8868244175156307e-10,1.0725572845876505e-08,8.5234176700163586e-08,4.4539022333561230e-07,
 1.7441122033571233e-06,5.5233951465642411e-06,1.4845258719024173e-05,3.4978045223652855e-05,7.3911363378808737e-05,1.4239837765149787e-04,2.5322601543841840e-04,4.1951938492769939e-04,6.5209512896242841e-04,9.5615408416399724e-04,
 1.3278811219735725e-03,1.7517190093518295e-03,2.1991297672695801e-03,2.6295069606308138e-03,2.9935578064185825e-03,3.2389895299243972e-03,3.3178088279063539e-03,3.1940984193460768e-03,2.8508861782916939e-03,2.2947521250994566e-03,
 1.5571804872658594e-03,6.9313567960421838e-04,4.1237343802185047e-15,7.2866246617776477e-12,4.0638516272876692e-10,6.3290617011303727e-09,5.0295902245238046e-08,2.6282066655815660e-07,1.0291845393587080e-06,3.2593045783814568e-06,
 8.7600503723276359e-06,2.0640222166831619e-05,4.3614414443046951e-05,8.4027970463478187e-05,1.4942633825449256e-04,2.4755452321117397e-04,3.8479532660080516e-04,5.6421771418841218e-04,7.8357041376750510e-04,1.0336732454801283e-03,
 1.2976862108761544e-03,1.5516478267901964e-03,1.7664708761926631e-03,1.9112978746014485e-03,1.9578084160276222e-03,1.8848080439168632e-03,1.6822816631416363e-03,1.3541120830798494e-03,9.1887785625276619e-04,4.0901297734941916e-04,
 1.8704361570049073e-15,3.3050543447442891e-12,1.8432746436930599e-10,2.8707246282632705e-09,2.2813126509785708e-08,1.1920973375410724e-07,4.6681570565778448e-07,1.4783496142089745e-06,3.9733681762300386e-06,9.3619555164972569e-06,
 1.9782549073044198e-05,3.8113258435986376e-05,6.7776534594655175e-05,1.1228534341723425e-04,1.7453478462948953e-04,2.5591687430283702e-04,3.5541048436596396e-04,4.6885168505256513e-04,5.8860221960776277e-04,7.0379368081721324e-04,
 8.0123274015331291e-04,8.6692311430392214e-04,8.8801928353894936e-04,8.5490790368728648e-04,7.6304634558924632e-04,6.1419576706479774e-04,4.1678299515383979e-04,1.8551938388380044e-04,5.3303353276766254e-16,9.4186844430399797e-13,
 5.2529309354352297e-11,8.1809394267515296e-10,6.5012437721790620e-09,3.3972175572671823e-08,1.3303230041095990e-07,4.2129741481759292e-07,1.1323233182970088e-06,2.6679532492373372e-06,5.6375952635771948e-06,1.0861447857141395e-05,
 1.9314834958915926e-05,3.1998875265306123e-05,4.9738609090444270e-05,7.2930730671360298e-05,1.0128424076639513e-04,1.3361251015796342e-04,1.6773880217050907e-04,2.0056585765871270e-04,2.2833386558187373e-04,2.4705419028859773e-04,
 2.5306613866389935e-04,2.4363011717177543e-04,2.1745157552245908e-04,1.7503240530472415e-04,1.1877406853601364e-04,5.2868980434386919e-05,4.5833789042307903e-17,8.0988149765528460e-14,4.5168214295721259e-12,7.0345190087143578e-11,
 5.5902043164056370e-10,2.9211549232584203e-09,1.1439007150618753e-08,3.6225970127166254e-08,9.7364733939042162e-08,2.2940846847919456e-07,4.8475815522348915e-07,9.3393994781794555e-07,1.6608187224120040e-06,2.7514773618200052e-06,
 4.2768583516169058e-06,6.2710721161130154e-06,8.7090965937798251e-06,1.1488897466161138e-05,1.4423304351930152e-05,1.7245994189686155e-05,1.9633673273714893e-05,2.1243372027480704e-05,2.1760319567602773e-05,2.0948947314485631e-05,
 1.8697941173915053e-05,1.5050457142254962e-05,1.0212988989098232e-05,4.5460286213696932e-06};


const double QUAD_SINGULAR_B1[N_SINGULAR_3D] =
{1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,
 1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,
 1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,1.7806396770512632e-14,7.1398724856442056e-11,7.1398724856442056e-11,
 7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,
 7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,
 7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,7.1398724856442056e-11,6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,
 6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,
 6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,
 6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,6.2569829906888412e-09,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,
 1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,
 1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,1.3357106048771199e-07,
 1.3357106048771199e-07,1.3357106048771199e-07,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,
 1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,
 1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,1.3555482760716257e-06,
 8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,
 8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,
 8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,8.6670071952908179e-06,4.0370853824161175e-05,4.0370853824161175e-05,
 4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,
 4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,
 4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,4.0370853824161175e-05,1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,
 1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,
 1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,
 1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,1.4911741320695670e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,
 4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,
 4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,4.6089653207903098e-04,
 4.6089653207903098e-04,4.6089653207903098e-04,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,
 1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,
 1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,1.2360260099013062e-03,
 2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,
 2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,
 2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,2.9505130295897366e-03,6.3873849115966240e-03,6.3873849115966240e-03,
 6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,
 6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,
 6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,6.3873849115966240e-03,1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,
 1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,
 1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,
 1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,1.2717513884222348e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,
 2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,
 2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,2.3541105843636372e-02,
 2.3541105843636372e-02,2.3541105843636372e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,
 4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,
 4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,4.0857850361017828e-02,
 6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,
 6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,
 6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,6.6938607605292841e-02,1.0408563168107235e-01,1.0408563168107235e-01,
 1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,
 1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,
 1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.0408563168107235e-01,1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,
 1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,
 1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,
 1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,1.5429045994566934e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,
 2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,
 2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,2.1882491204894233e-01,
 2.1882491204894233e-01,2.1882491204894233e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,
 2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,
 2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,2.9782533084768054e-01,
 3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,
 3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,
 3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,3.8994672736008934e-01,4.9216626121194523e-01,4.9216626121194523e-01,
 4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,
 4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,
 4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,4.9216626121194523e-01,5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,
 5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,
 5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,
 5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,5.9980144189562135e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,
 7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,
 7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,7.0677819608922143e-01,
 7.0677819608922143e-01,7.0677819608922143e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,
 8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,
 8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,8.0614209754455468e-01,
 8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,
 8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,
 8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,8.9076047257788082e-01,9.5412371075267288e-01,9.5412371075267288e-01,
 9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,
 9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,
 9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.5412371075267288e-01,9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,
 9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,
 9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,
 9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01,9.9113782726479638e-01};


const double QUAD_SINGULAR_B2[N_SINGULAR_3D] =
{1.7806396770512317e-14,7.1398724856440789e-11,6.2569829906887303e-09,1.3357106048770961e-07,1.3555482760716016e-06,8.6670071952906637e-06,4.0370853824160457e-05,1.4911741320695405e-04,4.6089653207902280e-04,1.2360260099012843e-03,
 2.9505130295896841e-03,6.3873849115965104e-03,1.2717513884222122e-02,2.3541105843635952e-02,4.0857850361017099e-02,6.6938607605291647e-02,1.0408563168107050e-01,1.5429045994566659e-01,2.1882491204893845e-01,2.9782533084767526e-01,
 3.8994672736008240e-01,4.9216626121193652e-01,5.9980144189561069e-01,7.0677819608920889e-01,8.0614209754454036e-01,8.9076047257786495e-01,9.5412371075265590e-01,9.9113782726477873e-01,1.7806396769241279e-14,7.1398724851344271e-11,
 6.2569829902421000e-09,1.3357106047817517e-07,1.3555482759748412e-06,8.6670071946720044e-06,4.0370853821278743e-05,1.4911741319630989e-04,4.6089653204612355e-04,1.2360260098130554e-03,2.9505130293790735e-03,6.3873849111405721e-03,
 1.2717513883314333e-02,2.3541105841955567e-02,4.0857850358100627e-02,6.6938607600513511e-02,1.0408563167364077e-01,1.5429045993465318e-01,2.1882491203331850e-01,2.9782533082641616e-01,3.8994672733224761e-01,4.9216626117680518e-01,
 5.9980144185279627e-01,7.0677819603875836e-01,8.0614209748699717e-01,8.9076047251428159e-01,9.5412371068454960e-01,9.9113782719403032e-01,1.7806396659098310e-14,7.1398724409701440e-11,6.2569829515390048e-09,1.3357105965196012e-07,
 1.3555482675899831e-06,8.6670071410615003e-06,4.0370853571561429e-05,1.4911741227393159e-04,4.6089652919520922e-04,1.2360260021675124e-03,2.9505130111284264e-03,6.3873848716308650e-03,1.2717513804649080e-02,2.3541105696340072e-02,
 4.0857850105370949e-02,6.6938607186459109e-02,1.0408563102981032e-01,1.5429045898027655e-01,2.1882491067975857e-01,2.9782532898419251e-01,3.8994672492019927e-01,4.9216625813246928e-01,5.9980143814267395e-01,7.0677819166692224e-01,
 8.0614209250053726e-01,8.9076046700440770e-01,9.5412370478273700e-01,9.9113782106326376e-01,1.7806394392093333e-14,7.1398715319638662e-11,6.2569821549369881e-09,1.3357104264648381e-07,1.3555480950096050e-06,8.6670060376294759e-06,
 4.0370848431783421e-05,1.4911739328918569e-04,4.6089647051659246e-04,1.2360258448040012e-03,2.9505126354865824e-03,6.3873840584268479e-03,1.2717512185530532e-02,2.3541102699225901e-02,4.0857844903591428e-02,6.6938598664232032e-02,
 1.0408561777824415e-01,1.5429043933692899e-01,2.1882488282026677e-01,2.9782529106683525e-01,3.8994667527449145e-01,4.9216619547277579e-01,5.9980136177950671e-01,7.0677810168410826e-01,8.0614198986729990e-01,8.9076035359805994e-01,
 9.5412358330935709e-01,9.9113769487746572e-01,1.7806372633082187e-14,7.1398628072023666e-11,6.2569745090463346e-09,1.3357087942569121e-07,1.3555464385604970e-06,8.6669954467441548e-06,4.0370799099519873e-05,1.4911721107110430e-04,
 4.6089590731153147e-04,1.2360243344083793e-03,2.9505090300268860e-03,6.3873762531880185e-03,1.2717496645018327e-02,2.3541073932530930e-02,4.0857794976229204e-02,6.6938516866778694e-02,1.0408549058797376e-01,1.5429025079750233e-01,
 2.1882461542121004e-01,2.9782492713106673e-01,3.8994619876847531e-01,4.9216559405681831e-01,5.9980062883581076e-01,7.0677723801725612e-01,8.0614100478002404e-01,8.9075926510905779e-01,9.5412241739192161e-01,9.9113648372962326e-01,
 1.7806242442343699e-14,7.1398106043179990e-11,6.2569287613722402e-09,1.3356990282636967e-07,1.3555365275249635e-06,8.6669320782770955e-06,4.0370503929680606e-05,1.4911612080526350e-04,4.6089253748547119e-04,1.2360152972549848e-03,
 2.9504874574720792e-03,6.3873295520856365e-03,1.2717403661438007e-02,2.3540901812702641e-02,4.0857496245734766e-02,6.6938027447899090e-02,1.0408472957015365e-01,1.5428912270914283e-01,2.1882301549185509e-01,2.9782274959339516e-01,
 3.8994334768899752e-01,4.9216199560341806e-01,5.9979624341220872e-01,7.0677207043751045e-01,8.0613511070519484e-01,8.9075275235045570e-01,9.5411544135560666e-01,9.9112923706611600e-01,1.7805677911071474e-14,7.1395842428957652e-11,
 6.2567303909431443e-09,1.3356566810995391e-07,1.3554935514303209e-06,8.6666573008102447e-06,4.0369224018322683e-05,1.4911139320966549e-04,4.6087792529250635e-04,1.2359761104759376e-03,2.9503939148595127e-03,6.3871270474140391e-03,
 1.2717000467328321e-02,2.3540155469093500e-02,4.0856200894713333e-02,6.6935905236550020e-02,1.0408142965525057e-01,1.5428423110806441e-01,2.1881607790040492e-01,2.9781330738478379e-01,3.8993098487775990e-01,4.9214639203975669e-01,
 5.9977722739928707e-01,7.0674966284998098e-01,8.0610955289977326e-01,8.9072451181705004e-01,9.5408519196381592e-01,9.9109781418445231e-01,1.7803741526687675e-14,7.1388078063285185e-11,6.2560499655707892e-09,1.3355114271669275e-07,
 1.3553461402192206e-06,8.6657147935976102e-06,4.0364833826869959e-05,1.4909517720403516e-04,4.6082780438041126e-04,1.2358416969000532e-03,2.9500730567191308e-03,6.3864324412814489e-03,1.2715617481449509e-02,2.3537595454828936e-02,
 4.0851757744062793e-02,6.6928625893283064e-02,1.0407011070092405e-01,1.5426745255139973e-01,2.1879228144411234e-01,2.9778091990475702e-01,3.8988857951281686e-01,4.9209287065220553e-01,5.9971200105616806e-01,7.0667280315290948e-01,
 8.0602188772029160e-01,8.9062764468042299e-01,9.5398143429304594e-01,9.9099003135586305e-01,1.7798189863992281e-14,7.1365817431760857e-11,6.2540991689271550e-09,1.3350949804914709e-07,1.3549235085721185e-06,8.6630126017310040e-06,
 4.0352247037636552e-05,1.4904868550833701e-04,4.6068410646574849e-04,1.2354563297997832e-03,2.9491531483665447e-03,6.3844409880418149e-03,1.2711652426176443e-02,2.3530255829591736e-02,4.0839019119478230e-02,6.6907755833185367e-02,
 1.0403765897439128e-01,1.5421934800774750e-01,2.1872405640584647e-01,2.9768806418552757e-01,3.8976700226575350e-01,4.9193942348894637e-01,5.9952499549111560e-01,7.0645244446969480e-01,8.0577054944743343e-01,8.9034992416515657e-01,
 9.5368395844321263e-01,9.9068101527739771e-01,1.7784387600961656e-14,7.1310474175445705e-11,6.2492491969688391e-09,1.3340596318277906e-07,1.3538727831447242e-06,8.6562945489694366e-06,4.0320954398792588e-05,1.4893310020570370e-04,
 4.6032685197750796e-04,1.2344982496041536e-03,2.9468661187426106e-03,6.3794899377106395e-03,1.2701794706280167e-02,2.3512008424511798e-02,4.0807348995262956e-02,6.6855869745226115e-02,1.0395697913305753e-01,1.5409975292409686e-01,
 2.1855443876603547e-01,2.9745721099234534e-01,3.8946474306259637e-01,4.9155793091189137e-01,5.9906007171266207e-01,7.0590459985562404e-01,8.0514568494431316e-01,8.8965946946518248e-01,9.5294438902951895e-01,9.8991275513089994e-01,
 1.7753858764831192e-14,7.1188061988457038e-11,6.2385216808488930e-09,1.3317695733336689e-07,1.3515487132208385e-06,8.6414350776335638e-06,4.0251739093937329e-05,1.4867744033635088e-04,4.5953665085583909e-04,1.2323790990541807e-03,
 2.9418075024519579e-03,6.3685388491899536e-03,1.2679990693802962e-02,2.3471647504113773e-02,4.0737298741166619e-02,6.6741104371370832e-02,1.0377852566860427e-01,1.5383522393325824e-01,2.1817926629474310e-01,2.9694659332847256e-01,
 3.8879618446016750e-01,4.9071411824551492e-01,5.9803171992614157e-01,7.0469283781263026e-01,8.0376356478204869e-01,8.8813227219729629e-01,9.5130855631225664e-01,9.8821346219133233e-01,1.7692660460450757e-14,7.0942673718586779e-11,
 6.2170172319419988e-09,1.3271789071132682e-07,1.3468898674661050e-06,8.6116476843029181e-06,4.0112989641576456e-05,1.4816494289178226e-04,4.5795260852422219e-04,1.2281310360153217e-03,2.9316669671830657e-03,6.3465862255877321e-03,
 1.2636282227925245e-02,2.3390739739368432e-02,4.0596875544101588e-02,6.6511044953071502e-02,1.0342079668775866e-01,1.5330494738980907e-01,2.1742719310743946e-01,2.9592300582313280e-01,3.8745598751742300e-01,4.8902260586108315e-01,
 5.9597027921570334e-01,7.0226373170367562e-01,8.0099295767409573e-01,8.8507084257549018e-01,9.4802935535881472e-01,9.8480704846161260e-01,1.7579943672355666e-14,7.0490710581764477e-11,6.1774097226314130e-09,1.3187236867142922e-07,
 1.3383090720499511e-06,8.5567844109500524e-06,3.9857436930134497e-05,1.4722101043411790e-04,4.5503507403312594e-04,1.2203068319591264e-03,2.9129898391703499e-03,6.3061532552995212e-03,1.2555778724826959e-02,2.3241721503219979e-02,
 4.0338240081772100e-02,6.6087314933682015e-02,1.0276192121502026e-01,1.5232826887910722e-01,2.1604200319174616e-01,2.9403773306755204e-01,3.8498757444078030e-01,4.8590712995163649e-01,5.9217345873053717e-01,6.9778973456739113e-01,
 7.9588997422637564e-01,8.7943221390035509e-01,9.4198962921390994e-01,9.7853301818537830e-01,1.7387214499444212e-14,6.9717919917495888e-11,6.1096866918432026e-09,1.3042665001512402e-07,1.3236371706284648e-06,8.4629762615589184e-06,
 3.9420479281288626e-05,1.4560702439952249e-04,4.5004651803439360e-04,1.2069285907767321e-03,2.8810546900671363e-03,6.2370188073286818e-03,1.2418129543805955e-02,2.2986922179295082e-02,3.9896011381125654e-02,6.5362798758631005e-02,
 1.0163534080886648e-01,1.5065829189742500e-01,2.1367353163317376e-01,2.9081419321127927e-01,3.8076695017792589e-01,4.8058012316408805e-01,5.8568145266679084e-01,6.9013985576711068e-01,7.8716462110124730e-01,8.6979098601159743e-01,
 9.3166258348992115e-01,9.6780534676752406e-01,1.7078865675794116e-14,6.8481526440290063e-11,6.0013361159438425e-09,1.2811363408574260e-07,1.3001634874507554e-06,8.3128919122277603e-06,3.8721387519667076e-05,1.4302479625192481e-04,
 4.4206529053943388e-04,1.1855246441464327e-03,2.8299614097385259e-03,6.1264100946803856e-03,1.2197903604976624e-02,2.2579266863744195e-02,3.9188486424894503e-02,6.4203639992380893e-02,9.9832916517115081e-02,1.4798648342107656e-01,
 2.0988419653718376e-01,2.8565682804618536e-01,3.7401434232484221e-01,4.7205740575860594e-01,5.7529484433632727e-01,6.7790075831497787e-01,7.7320486435336222e-01,8.5436591448178423e-01,9.1514026695284112e-01,9.5064206623126701e-01,
 1.6614461364227133e-14,6.6619393629758414e-11,5.8381492614821292e-09,1.2462999968230221e-07,1.2648097619296361e-06,8.0868498015329963e-06,3.7668485081335017e-05,1.3913570119717991e-04,4.3004475997155246e-04,1.1532881498345869e-03,
 2.7530097956677256e-03,5.9598222593752895e-03,1.1866221212611525e-02,2.1965296996974533e-02,3.8122882748105887e-02,6.2457830417157474e-02,9.7118284424624016e-02,1.4396247139012602e-01,2.0417707712703548e-01,2.7788931789115112e-01,
 3.6384423639036423e-01,4.5922133697611478e-01,5.5965156853548148e-01,6.5946744775722832e-01,7.5218006800291204e-01,8.3113420683368489e-01,8.9025599807169387e-01,9.2479244116275572e-01,1.5953006714690019e-14,6.3967143478536210e-11,
 5.6057209636852684e-09,1.1966823228253777e-07,1.2144551774825220e-06,7.7648962765845735e-06,3.6168828002369126e-05,1.3359643305866313e-04,4.1292382539796942e-04,1.1073734618864935e-03,2.6434070171216543e-03,5.7225499182829388e-03,
 1.1393803418170256e-02,2.1090814971430498e-02,3.6605135197060559e-02,5.9971260348844500e-02,9.3251812958624503e-02,1.3823103995986116e-01,1.9604838285077308e-01,2.6682599315577538e-01,3.4935887592084758e-01,4.4093882502158827e-01,
 5.3737072993269763e-01,6.3321274109086600e-01,7.2223428809692514e-01,7.9804510611308155e-01,8.5481314161709221e-01,8.8797462043093445e-01,1.5059039622815158e-14,6.0382582758807317e-11,5.2915902071832302e-09,1.1296232012963209e-07,
 1.1464001090779753e-06,7.3297706687769719e-06,3.4142016219231964e-05,1.2611001893734691e-04,3.8978459415719334e-04,1.0453189883288232e-03,2.4952770171786458e-03,5.4018723557363521e-03,1.0755322817660246e-02,1.9908937795392032e-02,
 3.4553873836425053e-02,5.6610619049749525e-02,8.8026211695264159e-02,1.3048491391542313e-01,1.8506231572134038e-01,2.5187372356772075e-01,3.2978166744139265e-01,4.1622970239981377e-01,5.0725780154947020e-01,5.9772906313504492e-01,
 6.8176206253283866e-01,7.5332462956241775e-01,8.0691152457557414e-01,8.3821471602655950e-01,1.3909913563296636e-14,5.5774905169324491e-11,4.8877992380596274e-09,1.0434238492420446e-07,1.0589205437821568e-06,6.7704501080537549e-06,
 3.1536705286748401e-05,1.1648680837697862e-04,3.6004088898317451e-04,9.6555272699444788e-04,2.3048672753905042e-03,4.9896659700937518e-03,9.9346050270261894e-03,1.8389725427867803e-02,3.1917134849259260e-02,5.2290772683385979e-02,
 8.1309102482903087e-02,1.2052786361806740e-01,1.7094056991571499e-01,2.3265372901898970e-01,3.0461666904174489e-01,3.8446802238878458e-01,4.6854994412598322e-01,5.5211751949188748e-01,6.2973812395041762e-01,6.9583989050935180e-01,
 7.4533767366340875e-01,7.7425217938519753e-01,1.2503200761129636e-14,5.0134376003969683e-11,4.3934949613786268e-09,9.3790215206283618e-08,9.5183166227059072e-07,6.0857529098941021e-06,2.8347390927377022e-05,1.0470647028344453e-04,
 3.2362986992604496e-04,8.6790615456611121e-04,2.0717755103817808e-03,4.4850598870488766e-03,8.9299161040938563e-03,1.6529968207235103e-02,2.8689347559522668e-02,4.7002594648763434e-02,7.3086293989167148e-02,1.0833885266570956e-01,
 1.5365331022025147e-01,2.0912540315315015e-01,2.7381071427110043e-01,3.4558668163443168e-01,4.2116537902014206e-01,4.9628174600302222e-01,5.6605256063310450e-01,6.2546944012633721e-01,6.6996150092814133e-01,6.9595187594400709e-01,
 1.0862850623775966e-14,4.3557025760989010e-11,3.8170929503219828e-09,8.1485462580512151e-08,8.2695666203888432e-07,5.2873361034808161e-06,2.4628371494696976e-05,9.0969565934501765e-05,2.8117143774319839e-04,7.5404171240834239e-04,
 1.7999701296679163e-03,3.8966450689303066e-03,7.7583609649133443e-03,1.4361328661472892e-02,2.4925465325770679e-02,4.0836116635567708e-02,6.3497780241830545e-02,9.4125400026972630e-02,1.3349485373059788e-01,1.8168931775869163e-01,
 2.3788827718124547e-01,3.0024763833529627e-01,3.6591083256256096e-01,4.3117235155476202e-01,4.9178962481985761e-01,5.4341134143440950e-01,5.8206629224800355e-01,6.0464687516009941e-01,9.0426890463129734e-15,3.6258681388546587e-11,
 3.1775070656947785e-09,6.7831891041360192e-08,6.8839314914515580e-07,4.4013986680875076e-06,2.0501681635589805e-05,7.5726853467292064e-05,2.3405880908014290e-04,6.2769570984746146e-04,1.4983700631594262e-03,3.2437295607345221e-03,
 6.4583826239136312e-03,1.1954967795779183e-02,2.0748994907678554e-02,3.3993683369462374e-02,5.2858195490715368e-02,7.8353901133537865e-02,1.1112667322578162e-01,1.5124575127016698e-01,1.9802810448344041e-01,2.4993863253660051e-01,
 3.0459940876831954e-01,3.5892581381386618e-01,4.0938615539049589e-01,4.5235822115383972e-01,4.8453621129786234e-01,5.0333322847415074e-01,7.1260943125936199e-15,2.8573666738039372e-11,2.5040355709572972e-09,5.3454945811655084e-08,
 5.4248846552474080e-07,3.4685237826356601e-06,1.6156357489871943e-05,5.9676573753678902e-05,1.8445012757333670e-04,4.9465582694201116e-04,1.1807910601099945e-03,2.5562222316786332e-03,5.0895307191381996e-03,9.4211166148058384e-03,
 1.6351252801723802e-02,2.6788734245152990e-02,4.1654919718148588e-02,6.1746819599518256e-02,8.7573414279304193e-02,1.1918926797220128e-01,1.5605611802702901e-01,1.9696422808464348e-01,2.4003967219555492e-01,2.8285161497452022e-01,
 3.2261690506457014e-01,3.5648105674204283e-01,3.8183893329641894e-01,3.9665192935407823e-01,5.2212237822007762e-15,2.0935662899335284e-11,1.8346838395688402e-09,3.9165947306482627e-08,3.9747631079786818e-07,2.5413554843108711e-06,
 1.1837614583738893e-05,4.3724476895052802e-05,1.3514491255243549e-04,3.6242977630390288e-04,8.6515475299855894e-04,1.8729205260508510e-03,3.7290523623920492e-03,6.9027655215256282e-03,1.1980412586774302e-02,1.9627859273299728e-02,
 3.0520176682716917e-02,4.5241326991492893e-02,6.4164235451608334e-02,8.7328880761481334e-02,1.1434088282562994e-01,1.4431387893659003e-01,1.7587486078092013e-01,2.0724277762208748e-01,2.3637844005043315e-01,2.6119039262170379e-01,
 2.7976987562094463e-01,2.9062322163479326e-01,3.4519107282209944e-15,1.3841207038663323e-11,1.2129655982743379e-09,2.5893805614897259e-08,2.6278374547634026e-07,1.6801678354453300e-06,7.8262090426872784e-06,2.8907588943882547e-05,
 8.9348434957829817e-05,2.3961340965984070e-04,5.7198026708372757e-04,1.2382450411376816e-03,2.4653905660433476e-03,4.5636294003289736e-03,7.9206171698253756e-03,1.2976578063650190e-02,2.0177822233442732e-02,2.9910424933953361e-02,
 4.2420938454805261e-02,5.7735793936230385e-02,7.5594254635392336e-02,9.5410319057886495e-02,1.1627624941563681e-01,1.3701453859509991e-01,1.5627701611102038e-01,1.7268095680416920e-01,1.8496442124951917e-01,1.9213990023780092e-01,
 1.9451623683015491e-15,7.7995629618596435e-12,6.8350986499108689e-10,1.4591239524948953e-08,1.4807945307593273e-07,9.4677977017767551e-07,4.4100929933788192e-06,1.6289515749136825e-05,5.0348119354806935e-05,1.3502289720306629e-04,
 3.2231264900518797e-04,6.9775490920598966e-04,1.3892552066966885e-03,2.5716192773529256e-03,4.4632922649212488e-03,7.3123418610968622e-03,1.1370265216273099e-02,1.6854616930206325e-02,2.3904329980413253e-02,3.2534298396136911e-02,
 4.2597596216618107e-02,5.3764009787904160e-02,6.5522026059783356e-02,7.7208116133044430e-02,8.8062581770843057e-02,9.7306253070711252e-02,1.0422802326486072e-01,1.0827142786059234e-01,8.1689140869670898e-16,3.2755085534044601e-12,
 2.8704716149644714e-10,6.1277446060065017e-09,6.2187524801777533e-08,3.9761012899982690e-07,1.8520649671987801e-06,6.8409535800955428e-06,2.1144222618747607e-05,5.6704286747451939e-05,1.3535858917346620e-04,2.9302951773841967e-04,
 5.8343234545948301e-04,1.0799785808846048e-03,1.8744065611860626e-03,3.0708949243137451e-03,4.7750625454916302e-03,7.0782737685706658e-03,1.0038874959678196e-02,1.3663121023149087e-02,1.7889308855420064e-02,2.2578761757134753e-02,
 2.7516664439367393e-02,3.2424360957493209e-02,3.6982808041400986e-02,4.0864785090068655e-02,4.3771655332222693e-02,4.5469725647567141e-02,1.5780336397185486e-16,6.3274783275106590e-13,5.5450464064715467e-11,1.1837298104664349e-09,
 1.2013102973454233e-08,7.6808514861919902e-08,3.5777348005737206e-07,1.3215042736667842e-06,4.0845446803406901e-06,1.0953876004949877e-05,2.6147956125693202e-05,5.6606108412802600e-05,1.1270480480432879e-04,2.0862534636401691e-04,
 3.6208932748844165e-04,5.9322150325211999e-04,9.2242484721044571e-04,1.3673487074325372e-03,1.9392641693434672e-03,2.6393795268913126e-03,3.4557752553924640e-03,4.3616624212996051e-03,5.3155439849031944e-03,6.2635904592182974e-03,
 7.1441705175592108e-03,7.8940731736767879e-03,8.4556091354436435e-03,8.7836346296150357e-03};




EXPORT double
triangle_integral_singular(double target[3], triangle6 vertices, integration_cb_3d function, void *args) {
	
	double sum_ = 0.0;
	
	for (int k=0; k < N_SINGULAR_3D; k++) {
		double b1_ = QUAD_SINGULAR_B1[k];
		double b2_ = QUAD_SINGULAR_B2[k];
		double w = QUAD_SINGULAR_WEIGHTS[k];
		
		double pos[3], jac;
		position_and_jacobian_3d(b1_, b2_, vertices, pos, &jac);
			
        sum_ += w*jac*function(target[0], target[1], target[2], pos[0], pos[1], pos[2], args);
	}
	      
    return sum_;
}

void
project_on_plane(triangle6 vertices, double point[3], double out[3]) {
	
	double v1[3] = {
		vertices[1][0] - vertices[0][0],
		vertices[1][1] - vertices[0][1],
		vertices[1][2] - vertices[0][2],
	};
	double v2[3] = {
		vertices[2][0] - vertices[0][0],
		vertices[2][1] - vertices[0][1],
		vertices[2][2] - vertices[0][2],
	};
	
	double normal[3];
	cross_product_3d(v1, v2, normal);

	double normal_length = norm_3d(normal[0], normal[1], normal[2]);

	double v[3] = {
		point[0]-vertices[0][0],
		point[1]-vertices[0][1],
		point[2]-vertices[0][2]
	};
	
	double dist = v[0]*normal[0]+v[1]*normal[1]+v[2]*normal[2];
		
	out[0] = point[0] - normal[0] * dist/normal_length;
	out[1] = point[1] - normal[1] * dist/normal_length;
	out[2] = point[2] - normal[2] * dist/normal_length;
}

#define N_GAUSSIAN_QUAD_SQUARE 12
const double GAUSSIAN_QUAD_SQUARE_WEIGHTS[N_GAUSSIAN_QUAD_SQUARE] = {0.2491470458134028, 0.2491470458134028, 0.2334925365383548, 0.2334925365383548, 0.2031674267230659, 0.2031674267230659, 0.1600783285433462, 0.1600783285433462, 0.1069393259953184, 0.1069393259953184, 0.0471753363865118, 0.0471753363865118};
const double GAUSSIAN_QUAD_SQUARE_POINTS[N_GAUSSIAN_QUAD_SQUARE] = {-0.1252334085114689, 0.1252334085114689, -0.3678314989981802, 0.3678314989981802, -0.5873179542866175, 0.5873179542866175, -0.7699026741943047, 0.7699026741943047, -0.9041172563704749, 0.9041172563704749, -0.9815606342467192, 0.9815606342467192};

EXPORT double
triangle_integral_johnston(double target[3], triangle6 vertices, integration_cb_3d pot, void* args) {
	
	double projected[3];
	project_on_plane(vertices, target, projected);
	
	double b = norm_3d(projected[0], projected[1], projected[2]);

	double s0 = projected[0], t0 = projected[1];
		
	double mu1 = 1/2.*(asinh((1+s0)/b) + asinh((1-s0)/b));
	double eta1 = 1/2.*(asinh((1+s0)/b) - asinh((1-s0)/b));
		
	double mu2 = 1/2.*(asinh((1+t0)/b) + asinh((1-t0)/b));
	double eta2 = 1/2.*(asinh((1+t0)/b) - asinh((1-t0)/b));

	double sum = 0.0;

	for(int i = 0; i < N_GAUSSIAN_QUAD_SQUARE; i++)
	for(int j = 0; j < N_GAUSSIAN_QUAD_SQUARE; j++) {
		
		double u = GAUSSIAN_QUAD_SQUARE_POINTS[i];
		double v = GAUSSIAN_QUAD_SQUARE_POINTS[j];
			
		double s = s0 + b*sinh(mu1*u - eta1);
		double t = t0 + b*sinh(mu2*v - eta2);
				
		double a = 1/2.*(s+1);
		double b = 1/4.*(1-s)*(t+1);
		
		double pos[3], jac;
		position_and_jacobian_3d(a, b, vertices, pos, &jac);
				
		double J = b*b*mu1*mu2*cosh(mu1*u-eta1)*cosh(mu2*v-eta2);
		sum += 1/8.*(1-s) * J * pot(target[0], target[1], target[2], pos[0], pos[1], pos[2], NULL);
	}

	return sum;
}




EXPORT inline double potential_3d_point(double x0, double y0, double z0, double x, double y, double z, void *_) {
	double r = norm_3d(x-x0, y-y0, z-z0);
    return 1/(4*r);
}

//////////////////////////////// PARTICLE TRACING


const double EM = -0.1758820022723908; // e/m units ns and mm

const double A[]  = {0.0, 2./9., 1./3., 3./4., 1., 5./6.};	// https://en.wikipedia.org/wiki/Runge%E2%80%93Kutta%E2%80%93Fehlberg_method
const double B6[] = {65./432., -5./16., 13./16., 4./27., 5./144.};
const double B5[] = {-17./12., 27./4., -27./5., 16./15.};
const double B4[] = {69./128., -243./128., 135./64.};
const double B3[] = {1./12., 1./4.};
const double B2[] = {2./9.};
const double CH[] = {47./450., 0., 12./25., 32./225., 1./30., 6./25.};
const double CT[] = {-1./150., 0., 3./100., -16./75., -1./20., 6./25.};

typedef void (*field_fun)(double pos[6], double field[3], void* args);

void
produce_new_y(double y[6], double ys[6][6], double ks[6][6], size_t index) {
	
	const double* coefficients[] = {NULL, B2, B3, B4, B5, B6};
	
	for(int i = 0; i < 6; i++) {
		
		ys[index][i] = y[i];
		
		for(int j = 0; j < index; j++) 
			ys[index][i] += coefficients[index][j]*ks[j][i];
	}
}

void
produce_new_k(double ys[6][6], double ks[6][6], size_t index, double h, field_fun ff, void *args) {
	
	double field[3] = { 0. };
	ff(ys[index], field, args);
	
	ks[index][0] = h*ys[index][3];
	ks[index][1] = h*ys[index][4];
	ks[index][2] = h*ys[index][5];
	ks[index][3] = h*EM*field[0];
	ks[index][4] = h*EM*field[1];
	ks[index][5] = h*EM*field[2];
}


EXPORT size_t
trace_particle(double *times_array, double *pos_array, field_fun field, double bounds[3][2], double atol, void *args) {
	
	double (*positions)[6] = (double (*)[6]) pos_array;
	
	double y[6];
	for(int i = 0; i < 6; i++) y[i] = positions[0][i];

    double V = norm_3d(y[3], y[4], y[5]);
    double hmax = TRACING_STEP_MAX/V;
    double h = hmax;
	
    int N = 1;
		
    double xmin = bounds[0][0], xmax = bounds[0][1];
	double ymin = bounds[1][0], ymax = bounds[1][1];
	double zmin = bounds[2][0], zmax = bounds[2][1];

	 
    while( (xmin <= y[0]) && (y[0] <= xmax) &&
		   (ymin <= y[1]) && (y[1] <= ymax) &&
		   (zmin <= y[2]) && (y[2] <= zmax) ) {
		
		double k[6][6] = { {0.} };
		double ys[6][6] = { {0.} };
		
		for(int index = 0; index < 6; index++) {
			produce_new_y(y, ys, k, index);
			produce_new_k(ys, k, index, h, field, args);
		}
		
		double TE = 0.0; // Error 
		
		for(int i = 0; i < 6; i++) {
			double err = 0.0;
			for(int j = 0; j < 6; j++) err += CT[j]*k[j][i];
			if(fabs(err) > TE) TE = fabs(err);
		}
			
		if(TE <= atol) {
			for(int i = 0; i < 6; i++) {
				y[i] += CH[0]*k[0][i] + CH[1]*k[1][i] + CH[2]*k[2][i] + CH[3]*k[3][i] + CH[4]*k[4][i] + CH[5]*k[5][i];
				positions[N][i] = y[i];
				times_array[N] = times_array[N-1] + h;
			}
				
			N += 1;
			if(N==TRACING_BLOCK_SIZE) return N;
		}
		
		h = fmin(0.9 * h * pow(atol / TE, 0.2), hmax);
	}
		
	return N;
}



//////////////////////////////// RADIAL RING POTENTIAL (DERIVATIVES)


EXPORT double dr1_potential_radial_ring(double r_0, double z_0, double r, double z, void *_) {
	
	if (fabs(r_0) < MIN_DISTANCE_AXIS) return 0.0; // Prevent stepping into singularity
	
    double s = norm_2d(z-z_0, r+r_0);
    double s1 = (r_0 + r) / s;
    double t = 4.0 * r * r_0 / pow(s, 2);
    double A = ellipe(t);
    double B = ellipk(t);
    double ellipe_term = -(2.0 * r * r_0 * s1 - r * s) / (2.0 * r_0 * pow(s, 2) - 8.0 * pow(r_0, 2) * r);
    double ellipk_term = -r / (2.0 * r_0 * s);
    return A * ellipe_term + B * ellipk_term;
}


EXPORT double potential_radial_ring(double r_0, double z_0, double r, double z, void *_) {
    double rz2 = pow(r + r_0, 2) + pow(z - z_0, 2);
    double t = 4.0 * r * r_0 / rz2;
    return ellipk(t) * r / sqrt(rz2);
}

EXPORT double dz1_potential_radial_ring(double r_0, double z_0, double r, double z, void *_) {
    double rz2 = pow(r + r_0, 2) + pow(z - z_0, 2);
    double t = 4.0 * r * r_0 / rz2;
    double numerator = r * (z - z_0) * ellipe(t);
    double denominator = ((pow(z - z_0, 2) + pow(r - r_0, 2)) * sqrt(rz2));
    return numerator / denominator;
}


EXPORT void
axial_derivatives_radial_ring(double *derivs_p, vertices_2d lines, charges_2d charges, size_t N_lines, double *z, size_t N_z) {

	double (*derivs)[9] = (double (*)[9]) derivs_p;	
		
	for(int i = 0; i < N_z; i++) 
	for(int j = 0; j < N_lines; j++)
	for(int k = 0; k < N_QUAD_2D; k++) {
		double z0 = z[i];

		double *v1 = &lines[j][0][0];
		double *v2 = &lines[j][2][0];
		double *v3 = &lines[j][3][0];
		double *v4 = &lines[j][1][0];
			
		double pos[2], jac;
		position_and_jacobian_radial(GAUSS_QUAD_POINTS[k], v1, v2, v3, v4, pos, &jac);
		double r = pos[0], z = pos[1];
		
		double weight = GAUSS_QUAD_WEIGHTS[k] * jac;
			
		double R = norm_2d(z0-z, r);
		
		double D[9] = {0.}; // Derivatives of the currently considered line element.
		D[0] = 1/R;
		D[1] = -(z0-z)/pow(R, 3);
			
		for(int n = 1; n+1 < DERIV_2D_MAX; n++)
			D[n+1] = -1./pow(R,2) *( (2*n + 1)*(z0-z)*D[n] + pow(n,2)*D[n-1]);
		
		for(int l = 0; l < 9; l++) derivs[i][l] += weight * M_PI*r/2 * charges[j][k]*D[l];
	}
}

//////////////////////////////// RADIAL SYMMETRY POTENTIAL EVALUATION



// John A. Crow. Quadrature of Integrands with a Logarithmic Singularity. 1993.
// Computed higher order points and weights with own Python code..
#define N_LOG_QUAD_2D 12
const double GAUSS_LOG_QUAD_POINTS[N_LOG_QUAD_2D] =
					{0.000245284264977222214486999757349594712755863,
					0.003593698020213691584953180874184458866517133,
					0.01712292595159614370417434799786314278267083,
					0.05020561232318819384573670241984682206686949,
					0.1115235855573625644218104518656856812018872,
					0.2060030029051239758752495945505766309866304,
					0.3324626975136065400973675503604997045074356,
					0.4826067009659319425485030383099190543511725,
					0.6416794701239928589863342367708391692838668,
					0.7907090871833554068663998987642233419999952,
					0.9098838287655625921196627463680156613773641,
					0.9823479377157619510221418912858930542857947};

const double GAUSS_LOG_QUAD_WEIGHTS[N_LOG_QUAD_2D] =
					{0.0009331998830671428063097434941623766739840873,
					0.006977495915143715985530451759041482867494198,
					0.02169468902199853397715717421909584842021132,
					0.04597069439559112469266362311262695693833166,
					0.07752703869583178458842135310107317470803586,
					0.1112525181837396068263131383589812009329696,
					0.1402731060085833332292272698216837072064324,
					0.1575171300868296275541516485738687199310457,
					0.1574083422236489759715520802610080785790687,
					0.1372838327177858585860313716723887135089706,
					0.09819669547418950067876642091789781881144955,
					0.04496525739359079510387572470817192142199618};



EXPORT double
potential_radial(double point[3], vertices_2d vertices, charges_2d charges, size_t N_vertices) {

	double sum_ = 0.0;
	
	for(int i = 0; i < N_vertices; i++) {
		double *v1 = &vertices[i][0][0];
		double *v2 = &vertices[i][2][0]; // Strange ordering following from GMSH line4 element
		double *v3 = &vertices[i][3][0]; // Strange ordering following from GMSH line4 element
		double *v4 = &vertices[i][1][0];
		
		for(int j = 0; j < N_QUAD_2D; j++) {
			double pos[2], jac;
			position_and_jacobian_radial(GAUSS_QUAD_POINTS[j], v1, v2, v3, v4, pos, &jac);
			sum_ += jac*GAUSS_QUAD_WEIGHTS[j] * charges[i][j] * potential_radial_ring(point[0], point[1], pos[0], pos[1], NULL);
		}
	}

	return sum_;
}

EXPORT double
potential_radial_derivs(double point[2], double *z_inter, double *coeff_p, size_t N_z) {
	
	double (*coeff)[DERIV_2D_MAX][6] = (double (*)[DERIV_2D_MAX][6]) coeff_p;
	
	double r = point[0], z = point[1];
	double z0 = z_inter[0], zlast = z_inter[N_z-1];
	
	if(!(z0 < z && z < zlast)) {
		return 0.0;
	}
	
	double dz = z_inter[1] - z_inter[0];
	int index = (int) ( (z-z0)/dz );
	double diffz = z - z_inter[index];
		
	double (*C)[6] = &coeff[index][0];
		
	double derivs[DERIV_2D_MAX];

	for(int i = 0; i < DERIV_2D_MAX; i++)
		derivs[i] = C[i][0]*pow(diffz, 5) + C[i][1]*pow(diffz, 4) + C[i][2]*pow(diffz, 3)
			      +	C[i][3]*pow(diffz, 2) + C[i][4]*diffz		  + C[i][5];
		
	return derivs[0] - pow(r,2)*derivs[2] + pow(r,4)/64.*derivs[4] - pow(r,6)/2304.*derivs[6] + pow(r,8)/147456.*derivs[8];
}


//////////////////////////////// RADIAL SYMMETRY FIELD EVALUATION


double
field_dot_normal_radial(double r0, double z0, double r, double z, void* args_p) {

	struct {double *normal; double K;} *args = args_p;
	
	// This factor is hard to derive. It takes into account that the field
	// calculated at the edge of the dielectric is basically the average of the
	// field at either side of the surface of the dielecric (the field makes a jump).
	double K = args->K;
	double factor = (2*K - 2) / (M_PI*(1 + K));
	
	double Er = -dr1_potential_radial_ring(r0, z0, r, z, NULL);
	double Ez = -dz1_potential_radial_ring(r0, z0, r, z, NULL);
	
	return factor*(args->normal[0]*Er + args->normal[1]*Ez);

}

EXPORT double
charge_radial(double *vertices_p, double *charges) {

	double (*vertices)[3] = (double (*)[3]) vertices_p;
		
	double *v1 = &vertices[0][0];
	double *v2 = &vertices[2][0]; // Strange ordering following from GMSH line4 element
	double *v3 = &vertices[3][0];
	double *v4 = &vertices[1][0];
		
	double sum_ = 0.0;
	
	for(int k = 0; k < N_QUAD_2D; k++) {
				
		double pos[2], jac;
		position_and_jacobian_radial(GAUSS_QUAD_POINTS[k], v1, v2, v3, v4, pos, &jac);
		
		// Surface area is 2pi*r * charge_integral
		// charge_integral is charge integrated over line element
		// charge_integral is weight*dl*charge
		// where dl is the jacobian
		sum_ += 2*M_PI*pos[0]*GAUSS_QUAD_WEIGHTS[k]*jac*charges[k];
	}

	return sum_;
}

EXPORT void
field_radial(double point[3], double result[3], vertices_2d vertices, charges_2d charges, size_t N_vertices) {
		
	double Ex = 0.0, Ey = 0.0;
	
	for(int i = 0; i < N_vertices; i++) 
	for(int k = 0; k < N_QUAD_2D; k++) {
			
		double *v1 = &vertices[i][0][0];
		double *v2 = &vertices[i][2][0]; // Strange ordering following from GMSH line4 element
		double *v3 = &vertices[i][3][0];
		double *v4 = &vertices[i][1][0];
		
		double pos[2], jac;
		position_and_jacobian_radial(GAUSS_QUAD_POINTS[k], v1, v2, v3, v4, pos, &jac);
		
		Ex -= GAUSS_QUAD_WEIGHTS[k] * jac * charges[i][k] * dr1_potential_radial_ring(point[0], point[1], pos[0], pos[1], NULL);
		Ey -= GAUSS_QUAD_WEIGHTS[k] * jac * charges[i][k] * dz1_potential_radial_ring(point[0], point[1], pos[0], pos[1], NULL);
	}
		
	result[0] = Ex;
	result[1] = Ey;
	result[2] = 0.0;
}

struct field_evaluation_args {
	double *vertices;
	double *charges;
	size_t N_vertices;
};

void
field_radial_traceable(double point[3], double result[3], void *args_p) {

	struct field_evaluation_args *args = (struct field_evaluation_args*)args_p;
	field_radial(point, result, (vertices_2d) args->vertices, (charges_2d) args->charges, args->N_vertices);
}

EXPORT size_t
trace_particle_radial(double *times_array, double *pos_array, double bounds[3][2], double atol,
	double *vertices, double *charges, size_t N_vertices) {

	struct field_evaluation_args args = { vertices, charges, N_vertices };
				
	return trace_particle(times_array, pos_array, field_radial_traceable, bounds, atol, (void*) &args);
}

EXPORT void
field_radial_derivs(double point[3], double field[3], double *z_inter, double *coeff_p, size_t N_z) {
	
	double (*coeff)[DERIV_2D_MAX][6] = (double (*)[DERIV_2D_MAX][6]) coeff_p;
	
	double r = point[0], z = point[1];
	double z0 = z_inter[0], zlast = z_inter[N_z-1];
	
	if(!(z0 < z && z < zlast)) {
		field[0] = 0.0, field[1] = 0.0; field[2] = 0.0;
		return;
	}
	
	double dz = z_inter[1] - z_inter[0];
	int index = (int) ( (z-z0)/dz );
	double diffz = z - z_inter[index];
		
	double (*C)[6] = &coeff[index][0];
		
	double derivs[DERIV_2D_MAX];

	for(int i = 0; i < DERIV_2D_MAX; i++)
		derivs[i] = C[i][0]*pow(diffz, 5) + C[i][1]*pow(diffz, 4) + C[i][2]*pow(diffz, 3)
			      +	C[i][3]*pow(diffz, 2) + C[i][4]*diffz		  + C[i][5];
		
	field[0] = r/2*(derivs[2] - pow(r,2)/8*derivs[4] + pow(r,4)/192*derivs[6] - pow(r,6)/9216*derivs[8]);
	field[1] = -derivs[1] + pow(r,2)/4*derivs[3] - pow(r,4)/64*derivs[5] + pow(r,6)/2304*derivs[7];
	field[2] = 0.0;
}

struct field_derivs_args {
	double *z_interpolation;
	double *axial_coefficients;
	size_t N_z;
};

void
field_radial_derivs_traceable(double point[3], double field[3], void *args_p) {
	struct field_derivs_args *args = (struct field_derivs_args*) args_p;
	field_radial_derivs(point, field, args->z_interpolation, args->axial_coefficients, args->N_z);
}

EXPORT size_t
trace_particle_radial_derivs(double *times_array, double *pos_array, double bounds[3][2], double atol,
	double *z_interpolation, double *axial_coefficients, size_t N_z) {

	struct field_derivs_args args = { z_interpolation, axial_coefficients, N_z };
		
	return trace_particle(times_array, pos_array, field_radial_derivs_traceable, bounds, atol, (void*) &args);
}


//////////////////////////////// 3D POINT POTENTIAL (DERIVATIVES)

EXPORT double dx1_potential_3d_point(double x0, double y0, double z0, double x, double y, double z, void *_) {
	double r = norm_3d(x-x0, y-y0, z-z0);
    return (x-x0)/(4*pow(r, 3));
}

EXPORT double dy1_potential_3d_point(double x0, double y0, double z0, double x, double y, double z, void *_) {
	double r = norm_3d(x-x0, y-y0, z-z0);
    return (y-y0)/(4*pow(r, 3));
}

EXPORT double dz1_potential_3d_point(double x0, double y0, double z0, double x, double y, double z, void *_) {
	double r = norm_3d(x-x0, y-y0, z-z0);
    return (z-z0)/(4*pow(r, 3));
}

EXPORT void
axial_coefficients_3d(double *restrict vertices_p, double *restrict charges, size_t N_v,
	double *restrict zs, double *restrict output_coeffs_p, size_t N_z,
	double *restrict thetas, double *restrict theta_coeffs_p, size_t N_t) {
	
	double (*vertices)[3][3] = (double (*)[3][3]) vertices_p;
	double (*theta_coeffs)[NU_MAX][M_MAX][4] = (double (*)[NU_MAX][M_MAX][4]) theta_coeffs_p;
	double (*output_coeffs)[2][NU_MAX][M_MAX] = (double (*)[2][NU_MAX][M_MAX]) output_coeffs_p;

	double theta0 = thetas[0];
	double dtheta = thetas[1] - thetas[0];
	
	for(int h = 0; h < N_v; h++) {

		double v1x = vertices[h][0][0], v1y = vertices[h][0][1], v1z = vertices[h][0][2];
		double v2x = vertices[h][1][0], v2y = vertices[h][1][1], v2z = vertices[h][1][2];
		double v3x = vertices[h][2][0], v3y = vertices[h][2][1], v3z = vertices[h][2][2];
			
		double area = 0.5*sqrt(pow((v2y-v1y)*(v3z-v1z)-(v2z-v1z)*(v3y-v1y), 2) + pow((v2z-v1z)*(v3x-v1x)-(v2x-v1x)*(v3z-v1z), 2) + pow((v2x-v1x)*(v3y-v1y)-(v2y-v1y)*(v3x-v1x), 2));
		
        for (int i=0; i < N_z; i++) 
		UNROLL
		for (int k=0; k < N_TRIANGLE_QUAD; k++) {
			double b1_ = QUAD_B1[k];
			double b2_ = QUAD_B2[k];
			double w = QUAD_WEIGHTS[k];

			double x = v1x + b1_*(v2x-v1x) + b2_*(v3x-v1x);
			double y = v1y + b1_*(v2y-v1y) + b2_*(v3y-v1y);
			double z = v1z + b1_*(v2z-v1z) + b2_*(v3z-v1z);

			double r = norm_3d(x, y, z-zs[i]);
			double theta = atan2((z-zs[i]), norm_2d(x, y));
			double mu = atan2(y, x);

			int index = (int) ((theta-theta0)/dtheta);

			double t = theta-thetas[index];
			double (*C)[M_MAX][4] = &theta_coeffs[index][0];
				
			UNROLL
			for (int nu=0; nu < NU_MAX; nu++)
			UNROLL
			for (int m=0; m < M_MAX; m++) {
				double base = pow(t, 3)*C[nu][m][0] + pow(t, 2)*C[nu][m][1] + t*C[nu][m][2] + C[nu][m][3];
				double r_dependence = pow(r, -2*nu - m - 1);
					
				output_coeffs[i][0][nu][m] += charges[h]*area*w*base*cos(m*mu)*r_dependence;
				output_coeffs[i][1][nu][m] += charges[h]*area*w*base*sin(m*mu)*r_dependence;
			}
		}
	}
}


//////////////////////////////// 3D POINT POTENTIAL EVALUATION

EXPORT double
potential_3d(double point[3], vertices_3d vertices, double *charges, size_t N_vertices) {
	
	double sum_ = 0.0;
		
	for(int i = 0; i < N_vertices; i++) {
		sum_ += charges[i] * triangle_integral(point, &vertices[i][0], potential_3d_point, NULL);
	}
	
	return sum_;
}

EXPORT double
potential_3d_derivs(double point[3], double *zs, double *coeffs_p, size_t N_z) {

	double (*coeffs)[2][NU_MAX][M_MAX][4] = (double (*)[2][NU_MAX][M_MAX][4]) coeffs_p;
	
	double xp = point[0], yp = point[1], zp = point[2];

	if (!(zs[0] < zp && zp < zs[N_z-1])) return 0.0;

	double dz = zs[1] - zs[0];
	int index = (int) ((zp-zs[0])/dz);
	
	double z_ = zp - zs[index];

	double A[NU_MAX][M_MAX], B[NU_MAX][M_MAX];
	double (*C)[NU_MAX][M_MAX][4] = &coeffs[index][0];
		
	for (int nu=0; nu < NU_MAX; nu++)
	for (int m=0; m < M_MAX; m++) {
		A[nu][m] = pow(z_, 3)*C[0][nu][m][0] + pow(z_, 2)*C[0][nu][m][1] + z_*C[0][nu][m][2] + C[0][nu][m][3];
		B[nu][m] = pow(z_, 3)*C[1][nu][m][0] + pow(z_, 2)*C[1][nu][m][1] + z_*C[1][nu][m][2] + C[1][nu][m][3];
	}

	double r = norm_2d(xp, yp);
	double phi = atan2(yp, xp);
	
	double sum_ = 0.0;
	
	for (int nu=0; nu < NU_MAX; nu++)
	for (int m=0; m < M_MAX; m++)
		sum_ += (A[nu][m]*cos(m*phi) + B[nu][m]*sin(m*phi))*pow(r, (m+2*nu));
	
	return sum_;
}

//////////////////////////////// 3D POINT FIELD EVALUATION

double
field_dot_normal_3d(double x0, double y0, double z0, double x, double y, double z, void* normal_p) {
	
	double Ex = -dx1_potential_3d_point(x0, y0, z0, x, y, z, NULL);
	double Ey = -dy1_potential_3d_point(x0, y0, z0, x, y, z, NULL);
	double Ez = -dz1_potential_3d_point(x0, y0, z0, x, y, z, NULL);
	
	double *normal = (double *)normal_p;
	
    return normal[0]*Ex + normal[1]*Ey + normal[2]*Ez;
}


EXPORT void
field_3d(double point[3], double result[3], vertices_3d vertices, double *charges, size_t N_vertices) {
		
	double Ex = 0.0, Ey = 0.0, Ez = 0.0;
	
	for(int i = 0; i < N_vertices; i++) {
		Ex -= charges[i]*triangle_integral(point, &vertices[i][0], dx1_potential_3d_point, NULL);
		Ey -= charges[i]*triangle_integral(point, &vertices[i][0], dy1_potential_3d_point, NULL);
		Ez -= charges[i]*triangle_integral(point, &vertices[i][0], dz1_potential_3d_point, NULL);
	} 

	result[0] = Ex;
	result[1] = Ey;
	result[2] = Ez;
}

void
field_3d_traceable(double point[3], double result[3], void *args_p) {

	struct field_evaluation_args *args = (struct field_evaluation_args*)args_p;
	field_3d(point, result, (vertices_3d) args->vertices, args->charges, args->N_vertices);
}

EXPORT size_t
trace_particle_3d(double *times_array, double *pos_array, double bounds[3][2], double atol,
	double *vertices, double *charges, size_t N_vertices) {

	struct field_evaluation_args args = { vertices, charges, N_vertices };
				
	return trace_particle(times_array, pos_array, field_3d_traceable, bounds, atol, (void*) &args);
}

EXPORT void
field_3d_derivs(double point[3], double field[3], double *restrict zs, double *restrict coeffs_p, size_t N_z) {
	
	double (*coeffs)[2][NU_MAX][M_MAX][4] = (double (*)[2][NU_MAX][M_MAX][4]) coeffs_p;

	double xp = point[0], yp = point[1], zp = point[2];

	field[0] = 0.0, field[1] = 0.0, field[2] = 0.0;
	
	if (!(zs[0] < zp && zp < zs[N_z-1])) return;
		
	double dz = zs[1] - zs[0];
	int index = (int) ((zp-zs[0])/dz);
	
	double z_ = zp - zs[index];

	double A[NU_MAX][M_MAX], B[NU_MAX][M_MAX];
	double Adiff[NU_MAX][M_MAX], Bdiff[NU_MAX][M_MAX];
	
	double (*C)[NU_MAX][M_MAX][4] = &coeffs[index][0];
		
	UNROLL
	for (int nu=0; nu < NU_MAX; nu++)
	UNROLL
	for (int m=0; m < M_MAX; m++) {
		A[nu][m] = pow(z_, 3)*C[0][nu][m][0] + pow(z_, 2)*C[0][nu][m][1] + z_*C[0][nu][m][2] + C[0][nu][m][3];
		B[nu][m] = pow(z_, 3)*C[1][nu][m][0] + pow(z_, 2)*C[1][nu][m][1] + z_*C[1][nu][m][2] + C[1][nu][m][3];
		
		Adiff[nu][m] = 3*pow(z_, 2)*C[0][nu][m][0] + 2*z_*C[0][nu][m][1]+ C[0][nu][m][2];
		Bdiff[nu][m] = 3*pow(z_, 2)*C[1][nu][m][0] + 2*z_*C[1][nu][m][1]+ C[1][nu][m][2];
	}
		
	double r = norm_2d(xp, yp);
	double phi = atan2(yp, xp);
	
	if(r < MIN_DISTANCE_AXIS) {
		field[0] = -A[0][1];
		field[1] = -B[0][1];
		field[2] = -Adiff[0][0];
		return;
	}
	
	
	UNROLL
	for (int nu=0; nu < NU_MAX; nu++)
	UNROLL
	for (int m=0; m < M_MAX; m++) {
		int exp = 2*nu + m;

		double diff_r = (A[nu][m]*cos(m*phi) + B[nu][m]*sin(m*phi)) * exp*pow(r, exp-1);
		double diff_theta = m*(-A[nu][m]*sin(m*phi) + B[nu][m]*cos(m*phi)) * pow(r, exp);
		
		field[0] -= diff_r * xp/r + diff_theta * -yp/pow(r,2);
		field[1] -= diff_r * yp/r + diff_theta * xp/pow(r,2);
		field[2] -= (Adiff[nu][m]*cos(m*phi) + Bdiff[nu][m]*sin(m*phi)) * pow(r, exp);
	}
}

void
field_3d_derivs_traceable(double point[3], double field[3], void *args_p) {
	struct field_derivs_args *args = (struct field_derivs_args*) args_p;
	field_3d_derivs(point, field, args->z_interpolation, args->axial_coefficients, args->N_z);
}

EXPORT size_t
trace_particle_3d_derivs(double *times_array, double *pos_array, double bounds[3][2], double atol,
	double *z_interpolation, double *axial_coefficients, size_t N_z) {

	struct field_derivs_args args = { z_interpolation, axial_coefficients, N_z };
	
	return trace_particle(times_array, pos_array, field_3d_derivs_traceable, bounds, atol, (void*) &args);
}


//////////////////////////////// SOLVER

enum ExcitationType{
    VOLTAGE_FIXED = 1,
    VOLTAGE_FUN = 2,
    DIELECTRIC = 3,
    FLOATING_CONDUCTOR = 4};


double legendre(int N, double x) {
	switch(N) {
		case 0:
			return 1;
		case 1:
			return x;
		case 2:
			return (3*pow(x,2)-1)/2.;
		case 3:
			return (5*pow(x,3) -3*x)/2.;
		case 4:
			return (35*pow(x,4)-30*pow(x,2)+3)/8.;
		case 5:
			return (63*pow(x,5)-70*pow(x,3)+15*x)/8.;
		case 6:
			return (231*pow(x,6)-315*pow(x,4)+105*pow(x,2)-5)/16.;
		case 7:
			return (429*pow(x,7)-693*pow(x,5)+315*pow(x,3)-35*x)/16.;
		case 8:
			return (6435*pow(x,8) - 12012*pow(x,6) + 6930*pow(x,4) - 1260*pow(x,2) + 35) / 128;
		/*case 9:
			return (12155*pow(x,9) - 25740*pow(x,7) + 18018*pow(x,5) - 4620*pow(x,3) + 315*x) / 128;
		case 10:
			return (46189*pow(x,10) - 109395*pow(x,8) + 90090*pow(x,6) - 30030*pow(x,4) + 3465*pow(x,2) - 63) / 256;
		case 11:
			return (88179*pow(x,11) - 230945*pow(x,9) + 218790*pow(x,7) - 90090*pow(x,5) + 15015*pow(x,3) - 693*x) / 256;
		case 12:
			return (676039*pow(x,12) - 1939938*pow(x,10) + 2078505*pow(x,8) - 1021020*pow(x,6) + 225225*pow(x,4) - 18018*pow(x,2) + 231) / 1024;
		case 13:
			return (1300075*pow(x,13) - 4056234*pow(x,11) + 4849845*pow(x,9) - 2771340*pow(x,7) + 765765*pow(x,5) - 90090*pow(x,3) + 3003*x) / 1024;
		case 14:
			return (5014575*pow(x,14) - 16900975*pow(x,12) + 22309287*pow(x,10) - 14549535*pow(x,8) + 4849845*pow(x,6) - 765765*pow(x,4) + 45045*pow(x,2) - 429) / 2048;
		case 15:
			return (9694845*pow(x,15) - 35102025*pow(x,13) + 50702925*pow(x,11) - 37182145*pow(x,9) + 14549535*pow(x,7) - 2909907*pow(x,5) + 255255*pow(x,3) - 6435*x) / 2048;
		case 16:
			return (300540195*pow(x,16) - 1163381400*pow(x,14) + 1825305300*pow(x,12) - 1487285800*pow(x,10) + 669278610*pow(x,8) - 162954792*pow(x,6) + 19399380*pow(x,4) - 875160*pow(x,2) + 6435) / 32768;*/
	}
	exit(1);
}


// Modified weight taking into account that the charge contribution
// is a sum of Legendre polynomials.
double legendre_log_weight(int k, int l, double legendre_arg) {

	double sum_ = 0.0;

	for(int i = 0; i < N_QUAD_2D; i++)
		sum_ += GAUSS_QUAD_WEIGHTS[k] * GAUSS_LOG_QUAD_WEIGHTS[l] * (2*i + 1)/2. * legendre(i, GAUSS_QUAD_POINTS[k]) * legendre(i, legendre_arg);
	
	return sum_;
}


double log_integral(
	double *v1,
	double *v2,
	double *v3,
	double *v4,
	int row, int k,
	integration_cb_2d callback, void *args) {
	
	double s = GAUSS_QUAD_POINTS[row];
	
	double spos[2], jac;
	position_and_jacobian_radial(s, v1, v2, v3, v4, spos, &jac);
	
	double spos_left1[2];
	position_and_jacobian_radial( -1 + 2*(s+1)/3., v1, v2, v3, v4, spos_left1, &jac);
	
	double spos_left2[2];
	position_and_jacobian_radial( -1 + (s+1)/3., v1, v2, v3, v4, spos_left2, &jac);
	
	double spos_right1[2];
	position_and_jacobian_radial( s + (1-s)/3, v1, v2, v3, v4, spos_right1, &jac);
	
	double spos_right2[2];
	position_and_jacobian_radial( s + 2*(1-s)/3, v1, v2, v3, v4, spos_right2, &jac);

	double integration_sum = 0.0;
	
	// Logarithmic integration using improved quadrature weights
	// split the integration around the singularity
	for(int l = 0; l < N_LOG_QUAD_2D; l++) {
		
		// To left direction
		double local_alpha = 2*GAUSS_LOG_QUAD_POINTS[l] - 1;
		double global_alpha = s + GAUSS_LOG_QUAD_POINTS[l]*(-s-1);
		
		assert( (-1<local_alpha) && (local_alpha<1) );
		assert( (-1<global_alpha) && (global_alpha<1) );
		
		double pos[2], jac;
		position_and_jacobian_radial(local_alpha, spos, spos_left1, spos_left2, v1, pos, &jac);
		double pot_ring = callback(spos[0], spos[1], pos[0], pos[1], args);
		integration_sum += 2*jac * legendre_log_weight(k, l, global_alpha) * pot_ring;
		// To right direction
		global_alpha = s + GAUSS_LOG_QUAD_POINTS[l]*(1-s);
			
		assert( (-1<local_alpha) && (local_alpha<1) );
		assert( (-1<global_alpha) && (global_alpha<1) );
		
		position_and_jacobian_radial(local_alpha, spos, spos_right1, spos_right2, v4, pos, &jac);
		pot_ring = callback(spos[0], spos[1], pos[0], pos[1], args);
		integration_sum += 2*jac * legendre_log_weight(k, l, global_alpha) * pot_ring;
	}
	
	return integration_sum;
}

void fill_self_voltages_radial(double *matrix, 
                        vertices_2d line_points,
						uint8_t *excitation_types,
						double *excitation_values,
						size_t N_lines,
						size_t N_matrix,
                        int lines_range_start, 
                        int lines_range_end) {
	 
	for(int i = lines_range_start; i <= lines_range_end; i++) {
		
		double *v1 = &line_points[i][0][0];
		double *v2 = &line_points[i][2][0];
		double *v3 = &line_points[i][3][0];
		double *v4 = &line_points[i][1][0];
		
		enum ExcitationType type_ = excitation_types[i];
			
		if (type_ == VOLTAGE_FIXED || type_ == VOLTAGE_FUN || type_ == FLOATING_CONDUCTOR) {
			for(int l = 0; l < N_QUAD_2D; l++) 
			for(int k = 0; k < N_QUAD_2D; k++) {

				matrix[(N_QUAD_2D*i + l)*N_matrix + N_QUAD_2D*i + k] = log_integral(v1, v2, v3, v4, l, k, potential_radial_ring, NULL);
			}
		}
		else if(type_ == DIELECTRIC) {
			for(int l = 0; l < N_QUAD_2D; l++)  {
				for(int k = 0; k < N_QUAD_2D; k++) {

					double normal[2];
					higher_order_normal_radial(GAUSS_QUAD_POINTS[l], v1, v2, v3, v4, normal);
					double K = excitation_values[i];

					struct {double *normal; double K;} args = {normal, K};

					matrix[(N_QUAD_2D*i + l)*N_matrix + N_QUAD_2D*i + k] = log_integral(v1, v2, v3, v4, l, k, field_dot_normal_radial, &args);
				}
				// When working with dielectrics, the constraint is that
				// the electric field normal must sum to the surface charge.
				// The constraint is satisfied by subtracting the integral
				// over the charge from the line element.
				matrix[(N_QUAD_2D*i + l)*N_matrix + N_QUAD_2D*i + l] -= 1;
			}
		}
	}
}

EXPORT void add_floating_conductor_constraints_radial(double *matrix, vertices_2d vertices, size_t N_matrix, int64_t *indices, size_t N_indices, int row) {
	for(int j = 0; j < N_indices; j++) {
		int i = indices[j];
			
		double *v1 = &vertices[i][0][0];
		double *v2 = &vertices[i][2][0]; // Strange ordering following from GMSH line4 element
		double *v3 = &vertices[i][3][0];
		double *v4 = &vertices[i][1][0];
			
		// An extra unknown voltage is added to the matrix for every floating conductor.
		// The column related to this unknown voltage is positioned at the rightmost edge of the matrix.
		// If multiple floating conductors are present the column lives at -len(floating) + i
		for(int k = 0; k < N_QUAD_2D; k++) {
			double pos[2], jac;
			position_and_jacobian_radial(GAUSS_QUAD_POINTS[k], v1, v2, v3, v4, pos, &jac);
			
			matrix[(N_QUAD_2D*i + k)*N_matrix + N_matrix - row - 1] = -1;
			// See charge_radial function
			matrix[(N_matrix - row - 1)*N_matrix + N_QUAD_2D*i + k] = 2*M_PI*pos[0]*GAUSS_QUAD_WEIGHTS[k]*jac;
		}
	}
}



EXPORT void fill_matrix_radial(double *matrix, 
						vertices_2d line_points,
                        uint8_t *excitation_types, 
                        double *excitation_values, 
						size_t N_lines,
						size_t N_matrix,
                        int lines_range_start, 
                        int lines_range_end) {
    
	assert(lines_range_start < N_lines && lines_range_end < N_lines);
	assert(N_matrix >= N_QUAD_2D*N_lines);
		
    for (int i = lines_range_start; i <= lines_range_end; i++) {
		
		double *target_v1 = &line_points[i][0][0];
		double *target_v2 = &line_points[i][2][0];
		double *target_v3 = &line_points[i][3][0];
		double *target_v4 = &line_points[i][1][0];
		
		enum ExcitationType type_ = excitation_types[i];
			
		if (type_ == VOLTAGE_FIXED || type_ == VOLTAGE_FUN || type_ == FLOATING_CONDUCTOR) {
			for (int j = 0; j < N_lines; j++) {
				
				if (i == j) continue;
					
				double *v1 = &line_points[j][0][0];
				double *v2 = &line_points[j][2][0]; // Strange ordering following from GMSH line4 element
				double *v3 = &line_points[j][3][0];
				double *v4 = &line_points[j][1][0];
					
				for(int l = 0; l < N_QUAD_2D; l++) {
					double target[2], jac_t;
					position_and_jacobian_radial(GAUSS_QUAD_POINTS[l], target_v1, target_v2, target_v3, target_v4, target, &jac_t);
						
					for(int k = 0; k < N_QUAD_2D; k++) {
						
						double pos[2], jac;
						position_and_jacobian_radial(GAUSS_QUAD_POINTS[k], v1, v2, v3, v4, pos, &jac);
						
						matrix[(N_QUAD_2D*i + l)*N_matrix + N_QUAD_2D*j + k] = GAUSS_QUAD_WEIGHTS[k]*jac*potential_radial_ring(target[0], target[1], pos[0], pos[1], NULL);
					}
				}
			} 
		}
		else if(type_ == DIELECTRIC) {
			            
            for (int j = 0; j < N_lines; j++) {

				if(i == j) continue;
					
				double *v1 = &line_points[j][0][0];
				double *v2 = &line_points[j][2][0]; // Strange ordering following from GMSH line4 element
				double *v3 = &line_points[j][3][0];
				double *v4 = &line_points[j][1][0];
				
				for(int l = 0; l < N_QUAD_2D; l++) {
					
					double normal[2];
					higher_order_normal_radial(GAUSS_QUAD_POINTS[l], target_v1, target_v2, target_v3, target_v4, normal);
					double K = excitation_values[i];
					
					struct {double *normal; double K;} args = {normal, K};

					double target[2], jac_t;
					position_and_jacobian_radial(GAUSS_QUAD_POINTS[l], target_v1, target_v2, target_v3, target_v4, target, &jac_t);
					
					for(int k = 0; k < N_QUAD_2D; k++) {
						
						double pos[2], jac;
						position_and_jacobian_radial(GAUSS_QUAD_POINTS[k], v1, v2, v3, v4, pos, &jac);
						matrix[(N_QUAD_2D*i + l)*N_matrix + N_QUAD_2D*j + k] = GAUSS_QUAD_WEIGHTS[k]*jac*field_dot_normal_radial(target[0], target[1], pos[0], pos[1], &args);
					}
				}
            }
		}
		else {
		    printf("ExcitationType unknown");
            exit(1);
		}
	}
	
	fill_self_voltages_radial(matrix, line_points, excitation_types, excitation_values, N_lines, N_matrix, lines_range_start, lines_range_end);
}


double singular_voltage_3d(double target[3], triangle6 source) {

	double (*v)[3] = &source[0];
				
	// Target
	double t[3], jac;
	position_and_jacobian_3d(1/3., 1/3., source, t, &jac);

	double s0[3], s1[3], s2[3];
	position_and_jacobian_3d(1/6., 1/6., source, s0, &jac);
	position_and_jacobian_3d(4/6., 1/6., source, s1, &jac);
	position_and_jacobian_3d(1/6., 4/6., source, s2, &jac);
				
	triangle6 triangle1 = {
		{ t[0], t[1], t[2] },
		{ v[0][0], v[0][1], v[0][2] },
		{ v[1][0], v[1][1], v[1][2] },
		{ s0[0], s0[1], s0[2] },
		{ v[3][0], v[3][1], v[3][2] },
		{ s1[0], s1[1], s1[2] } };
	
	triangle6 triangle2 = {
		{ t[0], t[1], t[2] },
		{ v[1][0], v[1][1], v[1][2] },
		{ v[2][0], v[2][1], v[2][2] },
		{ s1[0], s1[1], s1[2] },
		{ v[4][0], v[4][1], v[4][2] },
		{ s2[0], s2[1], s2[2] } };
		
	triangle6 triangle3 = {
		{ t[0], t[1], t[2] },
		{ v[2][0], v[2][1], v[2][2] },
		{ v[0][0], v[0][1], v[0][2] },
		{ s2[0], s2[1], s2[2] },
		{ v[5][0], v[5][1], v[5][2] },
		{ s0[0], s0[1], s0[2] } };

		
	double sum_ = 0.0;
	sum_ += triangle_integral_singular(target, triangle1, potential_3d_point, NULL);
	sum_ += triangle_integral_singular(target, triangle2, potential_3d_point, NULL);
	sum_ += triangle_integral_singular(target, triangle3, potential_3d_point, NULL);
	return sum_;
}

void fill_self_voltages_3d(double *matrix, 
                        vertices_3d line_points,
						uint8_t *excitation_types,
						double *excitation_values,
						size_t N_lines,
						size_t N_matrix,
                        int lines_range_start, 
                        int lines_range_end) {

	for (int i = lines_range_start; i <= lines_range_end; i++) {
		
		double (*v)[3] = &line_points[i][0];
				
		// Target
		double t[3], jac;
		position_and_jacobian_3d(1/3., 1/3., &line_points[i][0], t, &jac);

		double s0[3], s1[3], s2[3];
		position_and_jacobian_3d(1/6., 1/6., &line_points[i][0], s0, &jac);
		position_and_jacobian_3d(4/6., 1/6., &line_points[i][0], s1, &jac);
		position_and_jacobian_3d(1/6., 4/6., &line_points[i][0], s2, &jac);
					
		triangle6 triangle1 = {
			{ t[0], t[1], t[2] },
			{ v[0][0], v[0][1], v[0][2] },
			{ v[1][0], v[1][1], v[1][2] },
			{ s0[0], s0[1], s0[2] },
			{ v[3][0], v[3][1], v[3][2] },
			{ s1[0], s1[1], s1[2] } };
		
		triangle6 triangle2 = {
			{ t[0], t[1], t[2] },
			{ v[1][0], v[1][1], v[1][2] },
			{ v[2][0], v[2][1], v[2][2] },
			{ s1[0], s1[1], s1[2] },
			{ v[4][0], v[4][1], v[4][2] },
			{ s2[0], s2[1], s2[2] } };
			
		triangle6 triangle3 = {
			{ t[0], t[1], t[2] },
			{ v[2][0], v[2][1], v[2][2] },
			{ v[0][0], v[0][1], v[0][2] },
			{ s2[0], s2[1], s2[2] },
			{ v[5][0], v[5][1], v[5][2] },
			{ s0[0], s0[1], s0[2] } };

		matrix[i*N_matrix + i] = 0.0;
		matrix[i*N_matrix + i] += triangle_integral_singular(t, triangle1, potential_3d_point, NULL);
		matrix[i*N_matrix + i] += triangle_integral_singular(t, triangle2, potential_3d_point, NULL);
		matrix[i*N_matrix + i] += triangle_integral_singular(t, triangle3, potential_3d_point, NULL);
	}
}

EXPORT void fill_matrix_3d(double *matrix, 
                    vertices_3d triangle_points, 
                    uint8_t *excitation_types, 
                    double *excitation_values, 
					size_t N_lines,
					size_t N_matrix,
                    int lines_range_start, 
                    int lines_range_end) {
    
	assert(lines_range_start < N_lines && lines_range_end < N_lines);
		
    for (int i = lines_range_start; i <= lines_range_end; i++) {
		// TODO: higher order
		double target[3], jac;
		position_and_jacobian_3d(1/3., 1/3., &triangle_points[i][0], target, &jac);
			
        enum ExcitationType type_ = excitation_types[i];
		 
        if (type_ == VOLTAGE_FIXED || type_ == VOLTAGE_FUN || type_ == FLOATING_CONDUCTOR) {
            for (int j = 0; j < N_lines; j++) {

				double *v0 = &triangle_points[j][0][0];
				double *v1 = &triangle_points[j][0][1];
				
				double distance = norm_3d(target[0]-v0[0], target[1]-v0[1], target[2]-v0[2]);
				double characteristic_length = norm_3d(v0[0]-v1[0], v0[1]-v1[1], v0[2]-v1[2]);

				matrix[i*N_matrix + j] = triangle_integral(target, &triangle_points[j][0], potential_3d_point, NULL);
            }
        } 
        else if (type_ == DIELECTRIC) {
			double *p1 = &triangle_points[i][0][0];
			double *p2 = &triangle_points[i][1][0];
			double *p3 = &triangle_points[i][2][0];

            double normal[3];
            normal_3d(p1, p2, p3, normal);
            double K = excitation_values[i];
            
            for (int j = 0; j < N_lines; j++) {
				// See comments in 'fill_matrix_2d'.
                double factor = (2*K - 2) / (M_PI*(1 + K));
                matrix[i*N_matrix + j] = factor * triangle_integral(target, &triangle_points[j][0], field_dot_normal_3d, normal);
				 
                if (i == j) matrix[i*N_matrix + j] -= 1.0;
            }
        }
        else {
            printf("ExcitationType unknown");
            exit(1);
        }
    }
	
	fill_self_voltages_3d(matrix, triangle_points, excitation_types, excitation_values, N_lines, N_matrix, lines_range_start, lines_range_end);
}

EXPORT bool
xy_plane_intersection_2d(double *positions_p, size_t N_p, double result[4], double z) {

	double (*positions)[4] = (double (*)[4]) positions_p;

	for(int i = N_p-1; i > 0; i--) {
	
		double z1 = positions[i-1][1];
		double z2 = positions[i][1];
		
		if(fmin(z1, z2) <= z && z <= fmax(z1, z2)) {
			double ratio = fabs( (z-z1)/(z1-z2) );
			
			for(int k = 0; k < 4; k++)
				result[k] = positions[i-1][k] + ratio*(positions[i][k] - positions[i-1][k]);

			return true;
		}
	}

	return false;
}

EXPORT bool
xy_plane_intersection_3d(double *positions_p, size_t N_p, double result[6], double z) {

	double (*positions)[6] = (double (*)[6]) positions_p;

	for(int i = N_p-1; i > 0; i--) {
	
		double z1 = positions[i-1][2];
		double z2 = positions[i][2];
		
		if(fmin(z1, z2) <= z && z <= fmax(z1, z2)) {
			double ratio = fabs( (z-z1)/(z1-z2) );
			
			for(int k = 0; k < 6; k++)
				result[k] = positions[i-1][k] + ratio*(positions[i][k] - positions[i-1][k]);

			return true;
		}
	}

	return false;
}










